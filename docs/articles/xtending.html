<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="emmeans">
<title>For developers: Extending **emmeans** • emmeans</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="For developers: Extending **emmeans**">
<meta property="og:description" content="emmeans">
<meta property="og:image" content="https://rvlenth.github.io/emmeans/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">emmeans</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/AQuickStart.html">Quick start guide for **emmeans**</a>
    <a class="dropdown-item" href="../articles/basics.html">Basics of estimated marginal means</a>
    <a class="dropdown-item" href="../articles/comparisons.html">Comparisons and contrasts in emmeans</a>
    <a class="dropdown-item" href="../articles/confidence-intervals.html">Confidence intervals and tests in emmeans</a>
    <a class="dropdown-item" href="../articles/FAQs.html">FAQs for emmeans</a>
    <a class="dropdown-item" href="../articles/interactions.html">Interaction analysis in emmeans</a>
    <a class="dropdown-item" href="../articles/messy-data.html">Working with messy data</a>
    <a class="dropdown-item" href="../articles/models.html">Models supported by emmeans</a>
    <a class="dropdown-item" href="../articles/predictions.html">Prediction in **emmeans**</a>
    <a class="dropdown-item" href="../articles/re-engineering-clds.html">Re-engineering CLDs</a>
    <a class="dropdown-item" href="../articles/sophisticated.html">Sophisticated models in emmeans</a>
    <a class="dropdown-item" href="../articles/transformations.html">Transformations and link functions in emmeans</a>
    <a class="dropdown-item" href="../articles/utilities.html">Utilities and options for emmeans</a>
    <a class="dropdown-item" href="../articles/vignette-topics.html">Index of vignette topics</a>
    <a class="dropdown-item" href="../articles/xplanations.html">Explanations supplement</a>
    <a class="dropdown-item" href="../articles/xtending.html">For developers: Extending **emmeans**</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rvlenth/emmeans/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>For developers: Extending **emmeans**</h1>
                        <h4 data-toc-skip class="author">emmeans
package, Version 1.10.2</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/emmeans/blob/HEAD/vignettes/xtending.Rmd" class="external-link"><code>vignettes/xtending.Rmd</code></a></small>
      <div class="d-none name"><code>xtending.Rmd</code></div>
    </div>

    
    
<!-- @index Vignettes!Extending **emmeans** -->
<div class="section level2">
<h2 id="contents">Contents<a class="anchor" aria-label="anchor" href="#contents"></a>
</h2>
<p>This vignette explains how developers may incorporate
<strong>emmeans</strong> support in their packages. If you are a user
looking for a quick way to obtain results for an unsupported model, you
are probably better off trying to use the <code><a href="../reference/qdrg.html">qdrg()</a></code>
function.</p>
<ol style="list-style-type: decimal">
<li><a href="#intro">Introduction</a></li>
<li><a href="#dataex">Data example</a></li>
<li><a href="#rlm">Supporting <code>rlm</code> objects</a></li>
<li><a href="#lqs">Supporting <code>lqs</code> objects</a></li>
<li><a href="#communic">Communication between methods</a></li>
<li><a href="#hooks">Hook functions</a></li>
<li><a href="#exported">Exported methods from
<strong>emmeans</strong></a></li>
<li><a href="#rsm">Existing support for <code>rsm</code>
objects</a></li>
<li><a href="#dispatch">Dispatching and restrictions</a></li>
<li><a href="#exporting">Exporting and registering your methods</a></li>
<li><a href="#concl">Conclusions</a></li>
</ol>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
<div class="section level2">
<h2 id="intro">Introduction<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<!-- @index `recover_data()`; `emm_basis()` -->
<p>Suppose you want to use <strong>emmeans</strong> for some type of
model that it doesn’t (yet) support. Or, suppose you have developed a
new package with a fancy model-fitting function, and you’d like it to
work with <strong>emmeans</strong>. What can you do? Well, there is hope
because <strong>emmeans</strong> is designed to be extended.</p>
<p>The first thing to do is to look at the help page for extending the
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/help.html" class="external-link">help</a></span><span class="op">(</span><span class="st">"extending-emmeans"</span>, package<span class="op">=</span><span class="st">"emmeans"</span><span class="op">)</span></span></code></pre></div>
<p>It gives details about the fact that you need to write two S3
methods, <code>recover_data</code> and <code>emm_basis</code>, for the
class of object that your model-fitting function returns. The
<code>recover_data</code> method is needed to recreate the dataset so
that the reference grid can be identified. The <code>emm_basis</code>
method then determines the linear functions needed to evaluate each
point in the reference grid and to obtain associated information—such as
the variance-covariance matrix—needed to do estimation and testing.</p>
<p>These methods must also be exported from your package so that they
are available to users. See the section on <a href="#exporting">exporting the methods</a> for details and
suggestions.</p>
<p>This vignette presents an example where suitable methods are
developed, and discusses a few issues that arise.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="dataex">Data example<a class="anchor" aria-label="anchor" href="#dataex"></a>
</h2>
<p>The <strong>MASS</strong> package contains various functions that do
robust or outlier-resistant model fitting. We will cobble together some
<strong>emmeans</strong> support for these. But first, let’s create a
suitable dataset (a simulated two-factor experiment) for testing.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fake</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>rep <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a1"</span>,<span class="st">"a2"</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b1"</span>,<span class="st">"b2"</span>,<span class="st">"b3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fake</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11.46</span>,<span class="fl">12.93</span>,<span class="fl">11.87</span>,<span class="fl">11.01</span>,<span class="fl">11.92</span>,<span class="fl">17.80</span>,<span class="fl">13.41</span>,<span class="fl">13.96</span>,<span class="fl">14.27</span>,<span class="fl">15.82</span>,</span>
<span>           <span class="fl">23.14</span>,<span class="fl">23.75</span>,<span class="op">-</span><span class="fl">2.09</span>,<span class="fl">28.43</span>,<span class="fl">23.01</span>,<span class="fl">24.11</span>,<span class="fl">25.51</span>,<span class="fl">24.11</span>,<span class="fl">23.95</span>,<span class="fl">30.37</span>,</span>
<span>           <span class="fl">17.75</span>,<span class="fl">18.28</span>,<span class="fl">17.82</span>,<span class="fl">18.52</span>,<span class="fl">16.33</span>,<span class="fl">20.58</span>,<span class="fl">20.55</span>,<span class="fl">20.77</span>,<span class="fl">21.21</span>,<span class="fl">20.10</span><span class="op">)</span></span></code></pre></div>
<p>The <code>y</code> values were generated using predetermined means
and Cauchy-distributed errors. There are some serious outliers in these
data.</p>
</div>
<div class="section level2">
<h2 id="rlm">Supporting <code>rlm</code><a class="anchor" aria-label="anchor" href="#rlm"></a>
</h2>
<!-- @index Examples!Robust regression; Examples!`rlm` objects -->
<p>The <strong>MASS</strong> package provides an <code>rlm</code>
function that fits robust-regression models using <em>M</em> estimation.
We’ll fit a model using the default settings for all tuning
parameters:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="va">fake.rlm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/rlm.html" class="external-link">rlm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="va">B</span>, data <span class="op">=</span> <span class="va">fake</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rvlenth.github.io/emmeans/">emmeans</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">fake.rlm</span>, <span class="op">~</span> <span class="va">B</span> <span class="op">|</span> <span class="va">A</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## A = a1:</span></span>
<span><span class="co">##  B  emmean    SE df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  b1   11.8 0.477 NA      10.9      12.8</span></span>
<span><span class="co">##  b2   23.3 0.477 NA      22.4      24.2</span></span>
<span><span class="co">##  b3   17.8 0.477 NA      16.9      18.7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A = a2:</span></span>
<span><span class="co">##  B  emmean    SE df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  b1   14.7 0.477 NA      13.7      15.6</span></span>
<span><span class="co">##  b2   24.7 0.477 NA      23.8      25.6</span></span>
<span><span class="co">##  b3   20.6 0.477 NA      19.7      21.6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>The first lesson to learn about extending <strong>emmeans</strong> is
that sometimes, it already works! It works here because <code>rlm</code>
objects inherit from <code>lm</code>, which is supported by the
<strong>emmeans</strong> package, and <code>rlm</code> objects aren’t
enough different to create any problems.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="lqs">Supporting <code>lqs</code> objects<a class="anchor" aria-label="anchor" href="#lqs"></a>
</h2>
<!-- @index Examples!`lqs` objects -->
<p>The <strong>MASS</strong> resistant-regression functions
<code>lqs</code>, <code>lmsreg</code>, and <code>ltsreg</code> are
another story, however. They create <code>lqs</code> objects that are
not extensions of any other class, and have other issues, including not
even having a <code>vcov</code> method. So for these, we really do need
to write new methods for <code>lqs</code> objects. First, let’s fit a
model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fake.lts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lqs.html" class="external-link">ltsreg</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="va">B</span>, data <span class="op">=</span> <span class="va">fake</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="rd-lqs">The <code>recover_data</code> method<a class="anchor" aria-label="anchor" href="#rd-lqs"></a>
</h3>
<!-- @index `recover_data()!for `lqs` objects@lqs -->
<p>It is usually an easy matter to write a <code>recover_data</code>
method. Look at the one for <code>lm</code> objects:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">emmeans</span><span class="fu">:::</span><span class="va">recover_data.lm</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## function(object, frame = object$model, ...) {</span></span>
<span><span class="co">##         fcall = object$call</span></span>
<span><span class="co">##     recover_data(fcall, delete.response(terms(object)), object$na.action, </span></span>
<span><span class="co">##                  frame = frame, pwts = weights(object), ...)</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x000001d47d21fb30&gt;</span></span>
<span><span class="co">## &lt;environment: namespace:emmeans&gt;</span></span></code></pre>
<p>Note that all it does is obtain the <code>call</code> component and
call the method for class <code>call</code>, with additional arguments
for its <code>terms</code> component and <code>na.action</code>. It
happens that we can access these attributes in exactly the same way as
for <code>lm</code> objects; so:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recover_data.lqs</span> <span class="op">=</span> <span class="fu">emmeans</span><span class="fu">:::</span><span class="va">recover_data.lm</span></span></code></pre></div>
<p>Let’s test it:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec.fake</span> <span class="op">=</span> <span class="fu"><a href="../reference/extending-emmeans.html">recover_data</a></span><span class="op">(</span><span class="va">fake.lts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rec.fake</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##    A  B</span></span>
<span><span class="co">## 1 a1 b1</span></span>
<span><span class="co">## 2 a1 b1</span></span>
<span><span class="co">## 3 a1 b1</span></span>
<span><span class="co">## 4 a1 b1</span></span>
<span><span class="co">## 5 a1 b1</span></span>
<span><span class="co">## 6 a2 b1</span></span></code></pre>
<p>Our recovered data excludes the response variable <code>y</code>
(owing to the <code>delete.response</code> call), and this is fine.</p>
<div class="section level4">
<h4 id="rdargs">Special arguments<a class="anchor" aria-label="anchor" href="#rdargs"></a>
</h4>
<!-- @index `recover_data()!`data` and `params` arguments;
    `recover_data.call()`!`frame` argument -->
<p>By the way, there are two special arguments <code>data</code> and
<code>params</code> that may be handed to <code>recover_data</code> via
<code>ref_grid</code> or <code>emmeans</code> or a related function; and
you may need to provide for if you don’t use the
<code>recover_data.call</code> function. The <code>data</code> argument
is needed to cover a desperate situation that occurs with certain kinds
of models where the underlying data information is not saved with the
object—e.g., models that are fitted by iteratively modifying the data.
In those cases, the only way to recover the data is to for the user to
give it explicitly, and <code>recover_data</code> just adds a few needed
attributes to it.</p>
<p>The <code>params</code> argument is needed when the model formula
refers to variables besides predictors. For example, a model may include
a spline term, and the knots are saved in the user’s environment as a
vector and referred to in the call to fit the model. In trying to
recover the data, we try to construct a data frame containing all the
variables present on the right-hand side of the model, but if some of
those are scalars or of different lengths than the number of
observations, an error occurs. So you need to exclude any names in
<code>params</code> when reconstructing the data.</p>
<p>Many model objects contain the model frame as a slot; for example, a
model fitted with <code>lm(..., model = TRUE)</code> has a member
<code>$model</code> containing the model frame. This can be useful for
recovering the data, provided none of the predictors are transformed
(when predictors are transformed, the original predictor values are not
in the model frame so it’s harder to recover them). Therefore, when the
model frame is available in the model object, it should be provided in
the <code>frame</code> argument of <code><a href="../reference/extending-emmeans.html">recover_data.call()</a></code>;
then when <code>data = NULL</code>, a check is made on
<code>trms</code>, and if it has no function calls, then
<code>data</code> is set to <code>frame</code>. Of course, in the rarer
case where the original data are available in the model object, specify
that as <code>data</code>.</p>
</div>
<div class="section level4">
<h4 id="rderrs">Error handling<a class="anchor" aria-label="anchor" href="#rderrs"></a>
</h4>
<!-- @index `recover_data()!Error handling -->
<p>If you check for any error conditions in <code>recover_data</code>,
simply have it return a character string with the desired message,
rather than invoking <code>stop</code>. This provides a cleaner exit.
The reason is that whenever <code>recover_data</code> throws an error,
an informative message suggesting that <code>data</code> or
<code>params</code> be provided is displayed. But a character return
value is tested for and throws a different error with your string as the
message.</p>
</div>
</div>
<div class="section level3">
<h3 id="ebreqs">The <code>emm_basis</code> method<a class="anchor" aria-label="anchor" href="#ebreqs"></a>
</h3>
<!-- @index `emm_basis()`!Arguments and returned value -->
<p>The <code>emm_basis</code> method has four required arguments:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="fu">emmeans</span><span class="fu">:::</span><span class="va">emm_basis.lm</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## function (object, trms, xlev, grid, ...) </span></span>
<span><span class="co">## NULL</span></span></code></pre>
<p>These are, respectively, the model object, its <code>terms</code>
component (at least for the right-hand side of the model), a
<code>list</code> of levels of the factors, and the grid of predictor
combinations that specify the reference grid.</p>
<p>The function must obtain six things and return them in a named
<code>list</code>. They are the matrix <code>X</code> of linear
functions for each point in the reference grid, the regression
coefficients <code>bhat</code>; the variance-covariance matrix
<code>V</code>; a matrix <code>nbasis</code> for non-estimable
functions; a function <code>dffun(k,dfargs)</code> for computing degrees
of freedom for the linear function <code>sum(k*bhat)</code>; and a list
<code>dfargs</code> of arguments to pass to <code>dffun</code>.
Optionally, the returned list may include a <code>model.matrix</code>
element (the model matrix for the data or a compact version thereof
obtained via <code><a href="../reference/extending-emmeans.html">.cmpMM()</a></code>), which, if included, enables the
<code>submodel</code> option.</p>
<p>To write your own <code>emm_basis</code> function, examining some of
the existing methods can help; but the best resource is the
<code>predict</code> method for the object in question, looking
carefully to see what it does to predict values for a new set of
predictors (e.g., <code>newdata</code> in <code>predict.lm</code>).
Following this advice, let’s take a look at it:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MASS</span><span class="fu">:::</span><span class="va"><a href="https://rdrr.io/pkg/MASS/man/predict.lqs.html" class="external-link">predict.lqs</a></span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## function (object, newdata, na.action = na.pass, ...) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     if (missing(newdata)) </span></span>
<span><span class="co">##         return(fitted(object))</span></span>
<span><span class="co">##     Terms &lt;- delete.response(terms(object))</span></span>
<span><span class="co">##     m &lt;- model.frame(Terms, newdata, na.action = na.action, xlev = object$xlevels)</span></span>
<span><span class="co">##     if (!is.null(cl &lt;- attr(Terms, "dataClasses"))) </span></span>
<span><span class="co">##         .checkMFClasses(cl, m)</span></span>
<span><span class="co">##     X &lt;- model.matrix(Terms, m, contrasts.arg = object$contrasts)</span></span>
<span><span class="co">##     drop(X %*% object$coefficients)</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x000001d47fe0e128&gt;</span></span>
<span><span class="co">## &lt;environment: namespace:MASS&gt;</span></span></code></pre>
<div class="section level6">
<h6 id="eblqs"></h6>
<!-- @index `emm_basis()`!for `lqs` objects@lqs -->
<p>Based on this, here is a listing of an <code>emm_basis</code> method
for <code>lqs</code> objects:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emm_basis.lqs</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">trms</span>, <span class="va">xlev</span>, <span class="va">grid</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">trms</span>, <span class="va">grid</span>, na.action <span class="op">=</span> <span class="va">na.pass</span>, xlev <span class="op">=</span> <span class="va">xlev</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">trms</span>, <span class="va">m</span>, contrasts.arg <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">contrasts</span><span class="op">)</span> </span>
<span>    <span class="va">bhat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span> </span>
<span>    <span class="va">Xmat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">trms</span>, data<span class="op">=</span><span class="va">object</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>                      <span class="co"># 5</span></span>
<span>    <span class="va">V</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Xmat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Xmat</span><span class="op">)</span></span>
<span>    <span class="va">nbasis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span> </span>
<span>    <span class="va">dfargs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Xmat</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Xmat</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">dffun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">k</span>, <span class="va">dfargs</span><span class="op">)</span> <span class="va">dfargs</span><span class="op">$</span><span class="va">df</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, bhat <span class="op">=</span> <span class="va">bhat</span>, nbasis <span class="op">=</span> <span class="va">nbasis</span>, V <span class="op">=</span> <span class="va">V</span>,                  <span class="co">#10</span></span>
<span>         dffun <span class="op">=</span> <span class="va">dffun</span>, dfargs <span class="op">=</span> <span class="va">dfargs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Before explaining it, let’s verify that it works:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">fake.lts</span>, <span class="op">~</span> <span class="va">B</span> <span class="op">|</span> <span class="va">A</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## A = a1:</span></span>
<span><span class="co">##  B  emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  b1   11.9 0.228 24     11.4     12.3</span></span>
<span><span class="co">##  b2   23.1 0.228 24     22.6     23.6</span></span>
<span><span class="co">##  b3   17.8 0.228 24     17.3     18.2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A = a2:</span></span>
<span><span class="co">##  B  emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  b1   13.9 0.228 24     13.4     14.4</span></span>
<span><span class="co">##  b2   24.1 0.228 24     23.6     24.5</span></span>
<span><span class="co">##  b3   20.5 0.228 24     20.0     21.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Hooray! Note the results are comparable to those we had for
<code>fake.rlm</code>, albeit the standard errors are quite a bit
smaller. (In fact, the SEs could be misleading; a better method for
estimating covariances should probably be implemented, but that is
beyond the scope of this vignette.)</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level3">
<h3 id="dissecting-emm_basis-lqs">Dissecting <code>emm_basis.lqs</code><a class="anchor" aria-label="anchor" href="#dissecting-emm_basis-lqs"></a>
</h3>
<p>Let’s go through the listing of this method, line-by-line:</p>
<ul>
<li><p>Lines 2–3: Construct the linear functions, <code>X</code>. This
is a pretty standard two-step process: First obtain a model frame,
<code>m</code>, for the grid of predictors, then pass it as data to
<code>model.matrix</code> to create the associated design matrix. As
promised, this code is essentially identical to what you find in
<code>predict.lqs</code>.</p></li>
<li><p>Line 4: Obtain the coefficients, <code>bhat</code>. Most model
objects have a <code>coef</code> method.</p></li>
<li><p>Lines 5–6: Obtain the covariance matrix, <code>V</code>, of
<code>bhat</code>. In many models, this can be obtained using the
object’s <code>vcov</code> method. But not in this case. Instead, I
cobbled one together using the inverse of the <strong>X’X</strong>
matrix as in ordinary regression, and the variance estimate found in the
last element of the <code>scale</code> element of the object. This
probably under-estimates the variances and distorts the covariances,
because robust estimators have some efficiency loss.</p></li>
<li>
<p>Line 7: Compute the basis for non-estimable functions. This
applies only when there is a possibility of rank deficiency in the
model. But <code>lqs</code> methods don’t allow rank deficiencies, so it
we have fitted such a model, we can be sure that all linear functions
are estimable; we signal that by setting <code>nbasis</code> equal to a
1 x 1 matrix of <code>NA</code>. If rank deficiency were possible, the
<strong>estimability</strong> package (which is required by
<strong>emmeans</strong>) provides a <code>nonest.basis</code> function
that makes this fairly painless—I would have coded
<code>nbasis = estimability::nonest.basis(Xmat)</code>.</p>
<p>There some subtleties you need to know regarding estimability.
Suppose the model is rank-deficient, so that the design matrix
<strong>X</strong> has <em>p</em> columns but rank <em>r</em> &lt;
<em>p</em>. In that case, <code>bhat</code> should be of length
<em>p</em> (not <em>r</em>), and there should be <em>p</em> - <em>r</em>
elements equal to <code>NA</code>, corresponding to columns of
<strong>X</strong> that were excluded from the fit. Also, <code>X</code>
should have all <em>p</em> columns. In other words, do not alter or
throw-out columns of <code>X</code> or their corresponding elements of
<code>bhat</code>—even those with <code>NA</code> coefficients—as they
are essential for assessing estimability. <code>V</code> should be
<em>r</em> x <em>r</em>, however—the covariance matrix for the
non-excluded predictors.</p>
</li>
<li><p>Lines 8–9: Obtain <code>dffun</code> and <code>dfargs</code>.
This is a little awkward because it is designed to allow support for
mixed models, where approximate methods may be used to obtain degrees of
freedom. The function <code>dffun</code> is expected to have two
arguments: <code>k</code>, the vector of coefficients of
<code>bhat</code>, and <code>dfargs</code>, a list containing any
additional arguments. In this case (and in many other models), the
degrees of freedom are the same regardless of <code>k</code>. We put the
required degrees of freedom in <code>dfargs</code> and write
<code>dffun</code> so that it simply returns that value. (Note: If
asymptotic tests and CIs are desired, return <code>Inf</code> degrees of
freedom.)</p></li>
<li><p>Line 10: Return these results in a named list.</p></li>
</ul>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="communic">Communication between methods<a class="anchor" aria-label="anchor" href="#communic"></a>
</h2>
<!-- @index `emm_basis()`!Communicating with `recover_data()`;
   `recover_data()!Communicating with `emm_basis()`; `misc` attribute and argument -->
<p>If you need to pass information obtained in
<code><a href="../reference/extending-emmeans.html">recover_data()</a></code> to the <code><a href="../reference/extending-emmeans.html">emm_basis()</a></code> method,
simply incorporate it as <code>attr(data, "misc")</code> where
<code>data</code> is the dataset returned by
<code><a href="../reference/extending-emmeans.html">recover_data()</a></code>. Subsequently, that attribute is available
in <code>emm_grid()</code> by adding a <code>misc</code> argument.</p>
</div>
<div class="section level2">
<h2 id="hooks">Hook functions<a class="anchor" aria-label="anchor" href="#hooks"></a>
</h2>
<!-- @index Hook functions; `emm_basis()`!Hook functions 
     `estHook`; `vcovHook`; `postGridHook` -->
<p>Most linear models supported by <strong>emmeans</strong> have
straightforward structure: Regression coefficients, their covariance
matrix, and a set of linear functions that define the reference grid.
However, a few are more complex. An example is the <code>clm</code>
class in the <strong>ordinal</strong> package, which allows a scale
model in addition to the location model. When a scale model is used, the
scale parameters are included in the model matrix, regression
coefficients, and covariance matrix, and we can’t just use the usual
matrix operations to obtain estimates and standard errors. To facilitate
using custom routines for these tasks, the <code>emm_basis.clm</code>
function function provided in <strong>emmeans</strong> includes, in its
<code>misc</code> part, the names (as character constants) of two “hook”
functions: <code>misc$estHook</code> has the name of the function to
call when computing estimates, standard errors, and degrees of freedom
(for the <code>summary</code> method); and <code>misc$vcovHook</code>
has the name of the function to call to obtain the covariance matrix of
the grid values (used by the <code>vcov</code> method). These functions
are called in lieu of the usual built-in routines for these purposes,
and return the appropriately sized matrices.</p>
<p>In addition, you may want to apply some form of special
post-processing after the reference grid is constructed. To provide for
this, give the name of your function to post-process the object in
<code>misc$postGridHook</code>. Again, <code>clm</code> objects (as well
as <code>polr</code> in the <strong>MASS</strong> package) serve as an
example. They allow a <code>mode</code> specification that in two cases,
calls for post-processing. The <code>"cum.prob"</code> mode uses the
<code>regrid</code> function to transform the linear predictor to the
cumulative-probability scale. And the <code>"prob"</code> mode performs
this, as well as applying the contrasts necessary to convert the
cumulative probabilities into the class probabilities.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="exported">Exported methods from <strong>emmeans</strong><a class="anchor" aria-label="anchor" href="#exported"></a>
</h2>
<!-- @index Extending **emmeans**!Exports useful to developers -->
<p>For package developers’ convenience, <strong>emmeans</strong> exports
some of its S3 methods for <code>recover_data</code> and/or
<code>emm_basis</code>—use <code>methods("recover_data")</code> and
<code>methods("emm_basis")</code> to discover which ones. It may be that
all you need is to invoke one of those methods and perhaps make some
small changes—especially if your model-fitting algorithm makes heavy use
of an existing model type supported by <strong>emmeans</strong>. For
those methods that are not exported, use <code><a href="../reference/extending-emmeans.html">recover_data()</a></code> and
<code><a href="../reference/extending-emmeans.html">.emm_basis()</a></code>, which run in <strong>emmeans</strong>’s
namespace, thus providing access to all available methods..</p>
<p>A few additional functions are exported because they may be useful to
developers. They are as follows:</p>
<ul>
<li><p><code>emmeans::.all.vars(expr, retain)</code> Some users of your
package may include <code>$</code> or <code>[[]]</code> operators in
their model formulas. If you need to get the variable names,
<code><a href="https://rdrr.io/r/base/allnames.html" class="external-link">base::all.vars</a></code> will probably not give you what you need.
For example, if <code>form = ~ data$x + data[[5]]</code>, then
<code>base::all.vars(form)</code> returns the names <code>"data"</code>
and <code>"x"</code>, whereas <code>emmeans::.all.vars(form)</code>
returns the names <code>"data$x"</code> and <code>"data[[5]]"</code>.
The <code>retain</code> argument may be used to specify regular
expressions for patterns to retain as parts of variable names.</p></li>
<li><p><code>emmeans::.diag(x, nrow, ncol)</code> The base
<code>diag</code> function has a booby trap whereby, for example,
<code>diag(57.6)</code> returns a 57 x 57 identity matrix rather than a
1 x 1 matrix with 57.6 as its only element. But
<code>emmeans::.diag(57.6)</code> will return the latter. The function
works identically to <code>diag</code> except for its tail run around
the identity-matrix trap.</p></li>
<li><p><code>emmeans::.aovlist.dffun(k, dfargs)</code> This function is
exported because it is needed for computing degrees of freedom for
models fitted using <code>aov</code>, but it may be useful for other
cases where Satterthwaite degrees-of-freedom calculations are needed. It
requires the <code>dfargs</code> slot to contain analogous
contents.</p></li>
<li><p><code>emmeans::.get.offset(terms, grid)</code> If
<code>terms</code> is a model formula containing an <code>offset</code>
call, this is will compute that offset in the context of
<code>grid</code> (a <code>data.frame</code>).</p></li>
<li><p><code>emmeans::.my.vcov(object, ...)</code> In a call to
<code>ref_grid</code>, <code>emmeans</code>, etc., the user may use
<code>vcov.</code> to specify an alternative function or matrix to use
as the covariance matrix of the fixed-effects coefficients. This
function supports that feature. Calling <code>.my.vcov</code> in place
of the <code>vcov</code> method will substitute the user’s
<code>vcov.</code> when it is specified.</p></li>
<li><p><code>emmeans::.std.link.labels(fam, misc)</code> This is useful
in <code>emm_basis</code> methods for generalized linear models. Call it
with <code>fam</code> equal to the <code>family</code> object for your
model, and <code>misc</code> either an existing list, or just
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> if none. It returns a new <code>misc</code> list
containing the link function and, in some cases, extra features that are
used for certain types of link functions (e.g., for a log link, the
setups for returning ratio comparisons with
<code>type = "response"</code>).</p></li>
<li><p><code>emmeans::.num.key(levs, key)</code> Returns integer indices
of elements of <code>key</code> in <code>levs</code> when
<code>key</code> is a character vector; or just returns integer values
if already integer. Also throws an error if levels are mismatched or
indices exceed legal range. This is useful in custom contrast functions
(<code>.emmc</code> functions).</p></li>
<li><p><code>emmeans::.get.excl(levs, exclude, include)</code> This is
support for the <code>exclude</code> and <code>include</code> arguments
of contrast functions. It checks legality and returns an integer vector
of <code>exclude</code> indices in <code>levs</code>, given specified
integer or character arguments <code>exclude</code> and
<code>include</code>. In your <code>.emmc</code> function,
<code>exclude</code> should default to <code>integer(0)</code> and
<code>include</code> should have no default.</p></li>
<li><p><code>emmeans::.cmpMM(X, weights, assign)</code> creates a
compact version of the model matrix <code>X</code> (or, preferably, its
QR decomposition). This is useful if we want an <code><a href="../reference/extending-emmeans.html">emm_basis()</a></code>
method to return a <code>model.matrix</code> element. The returned
result is just the R portion of the QR decomposition of
<code>diag(sqrt(weights)) %*% X</code>, with the <code>assign</code>
attribute added. If <code>X</code> is a <code>qr</code> object, we
assume the weights are already incorporated, as is true of the
<code>qr</code> slot of a <code>lm</code> object.</p></li>
</ul>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="rsm">Existing support for <code>rsm</code> objects<a class="anchor" aria-label="anchor" href="#rsm"></a>
</h2>
<!-- @index **rsm** package -->
<p>As a nontrivial example of how an existing package supports
<strong>emmeans</strong>, we show the support offered by the
<strong>rsm</strong> package. Its <code>rsm</code> function returns an
<code>rsm</code> object which is an extension of the <code>lm</code>
class. Part of that extension has to do with <code>coded.data</code>
structures whereby, as is typical in response-surface analysis, models
are fitted to variables that have been linearly transformed (coded) so
that the scope of each predictor is represented by plus or minus 1 on
the coded scale.</p>
<p>Without any extra support in <strong>rsm</strong>,
<code>emmeans</code> will work just fine with <code>rsm</code> objects;
but if the data are coded, it becomes awkward to present results in
terms of the original predictors on their original, uncoded scale. The
<code>emmeans</code>-related methods in <strong>rsm</strong> provide a
<code>mode</code> argument that may be used to specify whether we want
to work with coded or uncoded data. The possible values for
<code>mode</code> are <code>"asis"</code> (ignore any codings, if
present), <code>"coded"</code> (use the coded scale), and
<code>"decoded"</code> (use the decoded scale). The first two are
actually the same in that no decoding is done; but it seems clearer to
provide separate options because they represent two different
situations.</p>
<div class="section level3">
<h3 id="rdrsm">The <code>recover_data</code> method<a class="anchor" aria-label="anchor" href="#rdrsm"></a>
</h3>
<!-- @index `recover_data()`!for `rsm` objects@rsm -->
<p>Note that coding is a <em>predictor</em> transformation, not a
response transformation (we could have that, too, as it’s already
supported by the <strong>emmeans</strong> infrastructure). So, to handle
the <code>"decode"</code> mode, we will need to actually decode the
predictors used to construct he reference grid. That means we need to
make <code>recover_data</code> a lot fancier! Here it is:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recover_data.rsm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">data</span>, <span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"asis"</span>, <span class="st">"coded"</span>, <span class="st">"decoded"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span></span>
<span>    <span class="va">cod</span> <span class="op">=</span> <span class="fu">rsm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rsm/man/coded.data.html" class="external-link">codings</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>    <span class="va">fcall</span> <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">call</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>                                                 <span class="co"># 5</span></span>
<span>        <span class="va">data</span> <span class="op">=</span> <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="../reference/extending-emmeans.html">recover_data</a></span><span class="op">(</span><span class="va">fcall</span>, </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">delete.response</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span>, <span class="va">object</span><span class="op">$</span><span class="va">na.action</span>, </span>
<span>                   weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cod</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="st">"decoded"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">pred</span> <span class="op">=</span> <span class="va">cpred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"predictors"</span><span class="op">)</span></span>
<span>        <span class="va">trms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"terms"</span><span class="op">)</span>                                    <span class="co">#10</span></span>
<span>        <span class="va">data</span> <span class="op">=</span> <span class="fu">rsm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rsm/man/coded.data.html" class="external-link">decode.data</a></span><span class="op">(</span><span class="fu">rsm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rsm/man/coded.data.html" class="external-link">as.coded.data</a></span><span class="op">(</span><span class="va">data</span>, formulas <span class="op">=</span> <span class="va">cod</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">form</span> <span class="kw">in</span> <span class="va">cod</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">vn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars</a></span><span class="op">(</span><span class="va">form</span><span class="op">)</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">vn</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> </span>
<span>                <span class="va">pred</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">=</span> <span class="va">vn</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>                                     <span class="co">#15</span></span>
<span>                <span class="va">cpred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cpred</span>, <span class="va">vn</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"predictors"</span><span class="op">)</span> <span class="op">=</span> <span class="va">pred</span></span>
<span>        <span class="va">new.trms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">trms</span>, <span class="fu"><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">reformulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="va">cpred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>           <span class="co">#20</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">new.trms</span>, <span class="st">"orig"</span><span class="op">)</span> <span class="op">=</span> <span class="va">trms</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"terms"</span><span class="op">)</span> <span class="op">=</span> <span class="va">new.trms</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"misc"</span><span class="op">)</span> <span class="op">=</span> <span class="va">cod</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Lines 2–7 ensure that <code>mode</code> is legal, retrieves the
codings from the object, and obtain the results we would get from
<code>recover_data</code> had it been an <code>lm</code> object. If
<code>mode</code> is not <code>"decoded"</code>, <em>or</em> if no
codings were used, that’s all we need. Otherwise, we need to return the
decoded data. However, it isn’t quite that simple, because the model
equation is still defined on the coded scale. Rather than to try to
translate the model coefficients and covariance matrix to the decoded
scale, we elected to remember what we will need to do later to put
things back on the coded scale. In lines 9–10, we retrieve the
attributes of the recovered data that provide the predictor names and
<code>terms</code> object on the coded scale. In line 11, we replace the
recovered data with the decoded data.</p>
<p>By the way, the codings comprise a list of formulas with the coded
name on the left and the original variable name on the right. It is
possible that only some of the predictors are coded (for example,
blocking factors will not be). In the <code>for</code> loop in lines
12–18, the coded predictor names are replaced with their decoded names.
For technical reasons to be discussed later, we also remove these coded
predictor names from a copy, <code>cpred</code>, of the list of all
predictors in the coded model. In line 19, the <code>"predictors"</code>
attribute of <code>data</code> is replaced with the modified
version.</p>
<p>Now, there is a nasty technicality. The <code>ref_grid</code>
function in <strong>emmeans</strong> has a few lines of code after
<code>recover_data</code> is called that determine if any terms in the
model convert covariates to factors or vice versa; and this code uses
the model formula. That formula involves variables on the coded scale,
and those variables are no longer present in the data, so an error will
occur if it tries to access them. Luckily, if we simply take those terms
out of the formula, it won’t hurt because those coded predictors would
not have been converted in that way. So in line 20, we update
<code>trms</code> with a simpler model with the coded variables excluded
(the intercept is explicitly included to ensure there will be a
right-hand side even is <code>cpred</code> is empty). We save that as
the <code>terms</code> attribute, and the original terms as a new
<code>"orig"</code> attribute to be retrieved later. The
<code>data</code> object, modified or not, is returned. If data have
been decoded, <code>ref_grid</code> will construct its grid using
decoded variables.</p>
<p>In line 23, we save the codings as the <code>"misc"</code> attribute,
to be accessed later by <code><a href="../reference/extending-emmeans.html">emm_basis()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="ebrsm">The <code>emm_basis</code> method<a class="anchor" aria-label="anchor" href="#ebrsm"></a>
</h3>
<!-- @index `emm_basis()`!for `rsm` objects@rsm -->
<p>Now comes the <code>emm_basis</code> method that will be called after
the grid is defined. It is listed below:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emm_basis.rsm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">trms</span>, <span class="va">xlev</span>, <span class="va">grid</span>, </span>
<span>                         <span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"asis"</span>, <span class="st">"coded"</span>, <span class="st">"decoded"</span><span class="op">)</span>, <span class="va">misc</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span></span>
<span>    <span class="va">cod</span> <span class="op">=</span> <span class="va">misc</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cod</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">mode</span> <span class="op">==</span> <span class="st">"decoded"</span><span class="op">)</span> <span class="op">{</span>                          <span class="co"># 5</span></span>
<span>        <span class="va">grid</span> <span class="op">=</span> <span class="fu">rsm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rsm/man/coded.data.html" class="external-link">coded.data</a></span><span class="op">(</span><span class="va">grid</span>, formulas <span class="op">=</span> <span class="va">cod</span><span class="op">)</span></span>
<span>        <span class="va">trms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">trms</span>, <span class="st">"orig"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">trms</span>, <span class="va">grid</span>, na.action <span class="op">=</span> <span class="va">na.pass</span>, xlev <span class="op">=</span> <span class="va">xlev</span><span class="op">)</span>     <span class="co">#10</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">trms</span>, <span class="va">m</span>, contrasts.arg <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">contrasts</span><span class="op">)</span></span>
<span>    <span class="va">bhat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span> </span>
<span>    <span class="va">V</span> <span class="op">=</span> <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="../reference/extending-emmeans.html">.my.vcov</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">bhat</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>                                         <span class="co">#15</span></span>
<span>        <span class="va">nbasis</span> <span class="op">=</span> <span class="fu">estimability</span><span class="fu">::</span><span class="fu"><a href="https://rvlenth.github.io/estimability/reference/nonest.basis.html" class="external-link">nonest.basis</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">qr</span><span class="op">)</span></span>
<span>    <span class="kw">else</span></span>
<span>        <span class="va">nbasis</span> <span class="op">=</span> <span class="fu">estimability</span><span class="fu">::</span><span class="va"><a href="https://rvlenth.github.io/estimability/reference/nonest.basis.html" class="external-link">all.estble</a></span></span>
<span>    <span class="va">dfargs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">df.residual</span><span class="op">)</span></span>
<span>    <span class="va">dffun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">k</span>, <span class="va">dfargs</span><span class="op">)</span> <span class="va">dfargs</span><span class="op">$</span><span class="va">df</span>                             <span class="co">#20</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, bhat <span class="op">=</span> <span class="va">bhat</span>, nbasis <span class="op">=</span> <span class="va">nbasis</span>, V <span class="op">=</span> <span class="va">V</span>, </span>
<span>         dffun <span class="op">=</span> <span class="va">dffun</span>, dfargs <span class="op">=</span> <span class="va">dfargs</span>, misc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is much simpler. The coding formulas are obtained from
<code>misc</code> (line 4) so that we don’t have to re-obtain them from
the object. All we have to do is determine if decoding was done (line
5); and, if so, convert the grid back to the coded scale (line 6) and
recover the original <code>terms</code> attribute (line 7). The rest is
borrowed directly from the <code>emm_basis.lm</code> method in
<strong>emmeans</strong>. Note that line 13 uses one of the exported
functions we described in the preceding section. Lines 15–18 use
functions from the <strong>estimability</strong> package to handle the
possibility that the model is rank-deficient.</p>
</div>
<div class="section level3">
<h3 id="demo">A demonstration<a class="anchor" aria-label="anchor" href="#demo"></a>
</h3>
<p>Here’s a demonstration of this <strong>rsm</strong> support. The
standard example for <code>rsm</code> fits a second-order model
<code>CR.rs2</code> to a dataset organized in two blocks and with two
coded predictors.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"rsm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/example.html" class="external-link">example</a></span><span class="op">(</span><span class="st">"rsm"</span><span class="op">)</span>   <span class="co">### (output is not shown) ###</span></span></code></pre></div>
<p>First, let’s look at some results on the coded scale—which are the
same as for an ordinary <code>lm</code> object.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">CR.rs2</span>, <span class="op">~</span> <span class="va">x1</span> <span class="op">*</span> <span class="va">x2</span>, mode <span class="op">=</span> <span class="st">"coded"</span>, </span>
<span>        at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  x1 x2 emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  -1 -2   75.0 0.298  7     74.3     75.7</span></span>
<span><span class="co">##   0 -2   77.0 0.240  7     76.4     77.5</span></span>
<span><span class="co">##   1 -2   76.4 0.298  7     75.6     77.1</span></span>
<span><span class="co">##  -1  2   76.8 0.298  7     76.1     77.5</span></span>
<span><span class="co">##   0  2   79.3 0.240  7     78.7     79.9</span></span>
<span><span class="co">##   1  2   79.2 0.298  7     78.5     79.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Block </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Now, the coded variables <code>x1</code> and <code>x2</code> are
derived from these coding formulas for predictors <code>Time</code> and
<code>Temp</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rsm/man/coded.data.html" class="external-link">codings</a></span><span class="op">(</span><span class="va">CR.rs1</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## $x1</span></span>
<span><span class="co">## x1 ~ (Time - 85)/5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $x2</span></span>
<span><span class="co">## x2 ~ (Temp - 175)/5</span></span></code></pre>
<p>Thus, for example, a coded value of <code>x1 = 1</code> corresponds
to a time of 85 + 1 x 5 = 90. Here are some results working with decoded
predictors. Note that the <code>at</code> list must now be given in
terms of <code>Time</code> and <code>Temp</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">CR.rs2</span>, <span class="op">~</span> <span class="va">Time</span> <span class="op">*</span> <span class="va">Temp</span>, mode <span class="op">=</span> <span class="st">"decoded"</span>, </span>
<span>        at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">85</span>, <span class="fl">90</span><span class="op">)</span>, Temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">165</span>, <span class="fl">185</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Time Temp emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##    80  165   75.0 0.298  7     74.3     75.7</span></span>
<span><span class="co">##    85  165   77.0 0.240  7     76.4     77.5</span></span>
<span><span class="co">##    90  165   76.4 0.298  7     75.6     77.1</span></span>
<span><span class="co">##    80  185   76.8 0.298  7     76.1     77.5</span></span>
<span><span class="co">##    85  185   79.3 0.240  7     78.7     79.9</span></span>
<span><span class="co">##    90  185   79.2 0.298  7     78.5     79.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Block </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Since the supplied settings are the same on the decoded scale as were
used on the coded scale, the EMMs are identical to those in the previous
output.</p>
</div>
</div>
<div class="section level2">
<h2 id="dispatch">Dispatching and restrictions<a class="anchor" aria-label="anchor" href="#dispatch"></a>
</h2>
<!-- @index Extending **emmeans**!Restrictions; 
    `recover_data()`!Dispatching; `emm_basis()`!Dispatching -->
<p>The <strong>emmeans</strong> package has internal support for a
number of model classes. When <code><a href="../reference/extending-emmeans.html">recover_data()</a></code> and
<code><a href="../reference/extending-emmeans.html">emm_basis()</a></code> are dispatched, a search is made for external
methods for a given class; and if found, those methods are used instead
of the internal ones. However, certain restrictions apply when you aim
to override an existing internal method:</p>
<ol style="list-style-type: decimal">
<li>The class name being extended must appear in the first or second
position in the results of <code>class(object)</code>. That is, you may
have a base class for which you provide <code><a href="../reference/extending-emmeans.html">recover_data()</a></code> and
<code><a href="../reference/extending-emmeans.html">emm_basis()</a></code> methods, and those will also work for
<em>direct</em> descendants thereof; but any class in third place or
later in the inheritance is ignored.</li>
<li>Certain classes vital to the correct operation of the package, e.g.,
<code>"lm"</code>, <code>"glm"</code>, etc., may not be overridden.</li>
</ol>
<p>If there are no existing internal methods for the class(es) you
provide methods for, there are no restrictions on them.</p>
</div>
<div class="section level2">
<h2 id="exporting">Exporting and registering your methods<a class="anchor" aria-label="anchor" href="#exporting"></a>
</h2>
<!-- @index **emmeans** package!Exporting extensions to 
     Registering `recover_data` and `emm_basis` methods -->
<p>To make the methods available to users of your package, the methods
must be exported. R and CRAN are evolving in a way that having S3
methods in the registry is increasingly important; so it is a good idea
to provide for that. The problem is not all of your package users will
have <strong>emmeans</strong> installed.</p>
<p>Thus, registering the methods must be done conditionally. We provide
a courtesy function <code><a href="../reference/extending-emmeans.html">.emm_register()</a></code> to make this simple.
Suppose that your package offers two model classes <code>foo</code> and
<code>bar</code>, and it includes the corresponding functions
<code>recover_data.foo</code>, <code>recover_data.bar</code>,
<code>emm_basis.foo</code>, and <code>emm_basis.bar</code>. Then to
register these methods, add or modify the <code>.onLoad</code> function
in your package (traditionally saved in the source file
<code>zzz.R</code>):</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"emmeans"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="../reference/extending-emmeans.html">.emm_register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="st">"bar"</span><span class="op">)</span>, <span class="va">pkgname</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>You should also add <code>emmeans (&gt;= 1.4)</code> and
<code>estimability</code> (which is required by
<strong>emmeans</strong>) to the <code>Suggests</code> field of your
<code>DESCRIPTION</code> file.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="concl">Conclusions<a class="anchor" aria-label="anchor" href="#concl"></a>
</h2>
<p>It is relatively simple to write appropriate methods that work with
<strong>emmeans</strong> for model objects it does not support. I hope
this vignette is helpful for understanding how. Furthermore, if you are
the developer of a package that fits linear models, I encourage you to
include <code>recover_data</code> and <code>emm_basis</code> methods for
those classes of objects, so that users have access to
<strong>emmeans</strong> support.</p>
<p><a href="#contents">Back to Contents</a></p>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell V. Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
