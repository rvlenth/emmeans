<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sophisticated models in emmeans • emmeans</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sophisticated models in emmeans">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">emmeans</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.7-100002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AQuickStart.html">Quick start guide for **emmeans**</a></li>
    <li><a class="dropdown-item" href="../articles/basics.html">Basics of estimated marginal means</a></li>
    <li><a class="dropdown-item" href="../articles/comparisons.html">Comparisons and contrasts in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/confidence-intervals.html">Confidence intervals and tests in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs for emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/interactions.html">Interaction analysis in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/messy-data.html">Working with messy data</a></li>
    <li><a class="dropdown-item" href="../articles/models.html">Models supported by emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/predictions.html">Prediction in **emmeans**</a></li>
    <li><a class="dropdown-item" href="../articles/re-engineering-clds.html">Re-engineering CLDs</a></li>
    <li><a class="dropdown-item" href="../articles/sophisticated.html">Sophisticated models in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/transformations.html">Transformations and link functions in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/utilities.html">Utilities and options for emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-topics.html">Index of vignette topics</a></li>
    <li><a class="dropdown-item" href="../articles/xplanations.html">Explanations supplement</a></li>
    <li><a class="dropdown-item" href="../articles/xtending.html">For developers: Extending **emmeans**</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rvlenth/emmeans/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Sophisticated models in emmeans</h1>
                        <h4 data-toc-skip class="author">emmeans
package, Version 1.10.7.100002</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/emmeans/blob/master/vignettes/sophisticated.Rmd" class="external-link"><code>vignettes/sophisticated.Rmd</code></a></small>
      <div class="d-none name"><code>sophisticated.Rmd</code></div>
    </div>

    
    
<!-- @index Vignettes!Sophisticated models -->
<p>This vignette gives a few examples of the use of the
<strong>emmeans</strong> package to analyze other than the basic types
of models provided by the <strong>stats</strong> package. Emphasis here
is placed on accessing the optional capabilities that are typically not
needed for the more basic models. A reference for all supported models
is provided in the <a href="models.html">“models” vignette</a>.</p>
<div class="section level2">
<h2 id="contents">Contents<a class="anchor" aria-label="anchor" href="#contents"></a>
</h2>
<ol style="list-style-type: decimal">
<li>
<a href="#lmer">Linear mixed models (lmer)</a>
<ol style="list-style-type: lower-alpha">
<li><a href="#lmerOpts">System options for lmerMod models</a></li>
<li><a href="#random-slopes">Bias adjustment with random slopes</a></li>
</ol>
</li>
<li><a href="#offsets">Models with offsets</a></li>
<li><a href="#ordinal">Ordinal models</a></li>
<li><a href="#mcmc">Models fitted using MCMC methods</a></li>
</ol>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
<div class="section level2">
<h2 id="lmer">Linear mixed models (lmer)<a class="anchor" aria-label="anchor" href="#lmer"></a>
</h2>
<!-- @index `lmerMod` models; Examples!`Oats`; Examples!Split-plot experiment -->
<p>Linear mixed models are really important in statistics. Emphasis here
is placed on those fitted using <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code>, but
<strong>emmeans</strong> also supports other mixed-model packages such
as <strong>nlme</strong>.</p>
<p>To illustrate, consider the <code>Oats</code> dataset in the
<strong>nlme</strong> package. It has the results of a balanced
split-plot experiment: experimental blocks are divided into plots that
are randomly assigned to oat varieties, and the plots are subdivided
into subplots that are randomly assigned to amounts of nitrogen within
each plot. We will consider a linear mixed model for these data,
excluding interaction (which is justified in this case). For sake of
illustration, we will exclude a few observations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="va">Oats.lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">yield</span> <span class="op">~</span> <span class="va">Variety</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">nitro</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">Block</span><span class="op">/</span><span class="va">Variety</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="fu">nlme</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nlme/man/Oats.html" class="external-link">Oats</a></span>, subset <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">8</span>,<span class="fl">13</span>,<span class="fl">21</span>,<span class="fl">34</span>,<span class="fl">55</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s look at the EMMs for <code>nitro</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Oats.emm.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">Oats.lmer</span>, <span class="st">"nitro"</span><span class="op">)</span></span>
<span><span class="va">Oats.emm.n</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  nitro emmean   SE   df lower.CL upper.CL</span></span>
<span><span class="co">##    0.0   78.9 7.29 7.78     62.0     95.8</span></span>
<span><span class="co">##    0.2   97.0 7.14 7.19     80.3    113.8</span></span>
<span><span class="co">##    0.4  114.2 7.14 7.19     97.4    131.0</span></span>
<span><span class="co">##    0.6  124.1 7.07 6.95    107.3    140.8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Variety </span></span>
<span><span class="co">## Degrees-of-freedom method: kenward-roger </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>You will notice that the degrees of freedom are fractional: that is
due to the fact that whole-plot and subplot variations are combined when
standard errors are estimated. Different degrees-of-freedom methods are
available. By default, the Kenward-Roger method is used, and that’s why
you see a message about the <strong>pbkrtest</strong> package being
loaded, as it implements that method. We may specify a different
degrees-of-freedom method via the optional argument
<code>lmer.df</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">Oats.lmer</span>, <span class="st">"nitro"</span>, lmer.df <span class="op">=</span> <span class="st">"satterthwaite"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  nitro emmean   SE   df lower.CL upper.CL</span></span>
<span><span class="co">##    0.0   78.9 7.28 7.28     61.8       96</span></span>
<span><span class="co">##    0.2   97.0 7.13 6.72     80.0      114</span></span>
<span><span class="co">##    0.4  114.2 7.13 6.72     97.2      131</span></span>
<span><span class="co">##    0.6  124.1 7.07 6.49    107.1      141</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Variety </span></span>
<span><span class="co">## Degrees-of-freedom method: satterthwaite </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<div class="section level6">
<h6 id="dfoptions"></h6>
<!-- @index Degrees of freedom; *z* tests; Asymptotic tests -->
<p>This latest result uses the Satterthwaite method, which is
implemented in the <strong>lmerTest</strong> package. Note that, with
this method, not only are the degrees of freedom slightly different, but
so are the standard errors. That is because the Kenward-Roger method
also entails making a bias adjustment to the covariance matrix of the
fixed effects; that is the principal difference between the methods. A
third possibility is <code>"asymptotic"</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">Oats.lmer</span>, <span class="st">"nitro"</span>, lmer.df <span class="op">=</span> <span class="st">"asymptotic"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  nitro emmean   SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##    0.0   78.9 7.28 Inf      64.6      93.2</span></span>
<span><span class="co">##    0.2   97.0 7.13 Inf      83.1     111.0</span></span>
<span><span class="co">##    0.4  114.2 7.13 Inf     100.2     128.2</span></span>
<span><span class="co">##    0.6  124.1 7.07 Inf     110.2     137.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Variety </span></span>
<span><span class="co">## Degrees-of-freedom method: asymptotic </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>This just sets all the degrees of freedom to <code>Inf</code> –
that’s <strong>emmeans</strong>’s way of using <em>z</em> statistics
rather than <em>t</em> statistics. The asymptotic methods tend to make
confidence intervals a bit too narrow and P values a bit too low; but
they involve much, much less computation. Note that the SEs are the same
as obtained using the Satterthwaite method.</p>
<p>Comparisons and contrasts are pretty much the same as with other
models. As <code>nitro</code> has quantitative levels, we might want to
test polynomial contrasts:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/contrast.html">contrast</a></span><span class="op">(</span><span class="va">Oats.emm.n</span>, <span class="st">"poly"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  contrast  estimate    SE   df t.ratio p.value</span></span>
<span><span class="co">##  linear      152.69 15.60 43.2   9.802  &lt;.0001</span></span>
<span><span class="co">##  quadratic    -8.27  6.95 44.2  -1.190  0.2402</span></span>
<span><span class="co">##  cubic        -6.32 15.20 42.8  -0.415  0.6800</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Variety </span></span>
<span><span class="co">## Degrees-of-freedom method: kenward-roger</span></span></code></pre>
<p>The interesting thing here is that the degrees of freedom are much
larger than they are for the EMMs. The reason is because
<code>nitro</code> within-plot factor, so inter-plot variations have
little role in estimating contrasts among <code>nitro</code> levels. On
the other hand, <code>Variety</code> is a whole-plot factor, and there
is not much of a bump in degrees of freedom for comparisons:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">Oats.lmer</span>, <span class="va">pairwise</span> <span class="op">~</span> <span class="va">Variety</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## $emmeans</span></span>
<span><span class="co">##  Variety     emmean   SE   df lower.CL upper.CL</span></span>
<span><span class="co">##  Golden Rain  105.2 7.53 8.46     88.0      122</span></span>
<span><span class="co">##  Marvellous   108.5 7.48 8.28     91.3      126</span></span>
<span><span class="co">##  Victory       96.9 7.64 8.81     79.6      114</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: nitro </span></span>
<span><span class="co">## Degrees-of-freedom method: kenward-roger </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $contrasts</span></span>
<span><span class="co">##  contrast                 estimate   SE   df t.ratio p.value</span></span>
<span><span class="co">##  Golden Rain - Marvellous    -3.23 6.55 9.56  -0.493  0.8764</span></span>
<span><span class="co">##  Golden Rain - Victory        8.31 6.71 9.80   1.238  0.4595</span></span>
<span><span class="co">##  Marvellous - Victory        11.54 6.67 9.80   1.729  0.2431</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: nitro </span></span>
<span><span class="co">## Degrees-of-freedom method: kenward-roger </span></span>
<span><span class="co">## P value adjustment: tukey method for comparing a family of 3 estimates</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="lmerOpts">System options for lmerMod models<a class="anchor" aria-label="anchor" href="#lmerOpts"></a>
</h3>
<!-- @index `lmerMod` models!System options for -->
<p>The computation required to compute the adjusted covariance matrix
and degrees of freedom may become cumbersome. Some user options (i.e.,
<code><a href="../reference/emm_options.html">emm_options()</a></code> calls) make it possible to streamline these
computations through default methods and limitations on them. First, the
option <code>lmer.df</code>, which may have values of
<code>"kenward-roger"</code>, <code>"satterthwaite"</code>, or
<code>"asymptotic"</code> (partial matches are OK!) specifies the
default degrees-of-freedom method.</p>
<p>The options <code>disable.pbkrtest</code> and
<code>disable.lmerTest</code> may be <code>TRUE</code> or
<code>FALSE</code>, and comprise another way of controlling which method
is used (e.g., the Kenward-Roger method will not be used if
<code>get_emm_option("disable.pbkrtest") == TRUE</code>). Finally, the
options <code>pbkrtest.limit</code> and <code>lmerTest.limit</code>,
which should be set to numeric values, enable the given package
conditionally on whether the number of data rows does not exceed the
given limit. The factory default is 3000 for both limits.</p>
</div>
<div class="section level3">
<h3 id="random-slopes">Bias adjustment with random slopes<a class="anchor" aria-label="anchor" href="#random-slopes"></a>
</h3>
<!-- @index Bias adjustment!with random slopes; Random slopes!Bias adjustment;
    Examples!`ChickWeight` -->
<p>In the <a href="transformations.html#cbpp"><code>cbpp</code>
example</a>, we saw an example where we applied a bias adjustment to the
inverse transformation. To do that adjustment, we required an estimate
of the total SD of the response. That computation was (relatively)
simple because the model had only random intercepts. But what if we have
random slopes as well? The short answer is “it gets more complicated;”
but here is an example of how we can muddle through it.</p>
<p>Our illustration is a model fitted to the <code>ChickWeight</code>
data in the R <strong>datasets</strong> package. The data comprise
weight determinations, over time (in days since birth), of chicks who
are randomized to different diets. Our model fits a trend in the square
root of weight for each diet, with random intercepts and slopes for each
chick (this is likely not the best model, but it’s not totally stupid
and it serves an an illustration).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cw.lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span> <span class="op">~</span> <span class="va">Time</span><span class="op">*</span><span class="va">Diet</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">Time</span><span class="op">|</span><span class="va">Chick</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ChickWeight</span><span class="op">)</span></span></code></pre></div>
<p>Our goal is to use this model to estimate the mean
<code>weight</code> at times 5, 10, 15, and 20, for each diet.
Accordingly, let’s get the estimates needed:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cw.emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">cw.lmer</span>, <span class="op">~</span> <span class="va">Time</span><span class="op">|</span><span class="va">Diet</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If we just summarize this with `type = “response”, we will
under-estimate the mean weights. We need to apply a bias adjustment; but
that involves providing an estimate of the SD of each transformed
response. The problem is that since random slopes are involved, that SD
depends on time. In particular, the model states that at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><msqrt><mi>Y</mi></msqrt><mi>t</mi></msub><mo>=</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>+</mo><mi>E</mi><mo>+</mo><mi>C</mi><mo>+</mo><mi>S</mi><mo>×</mo><mi>t</mi></mrow><annotation encoding="application/x-tex"> \sqrt Y_t = \mu_t + E + C + S\times t </annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\mu_t</annotation></semantics></math>
is the mean at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
is the residual error,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is the random intercept for chicks, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
is the random slope for chicks. For purposes of bias correction, we need
an estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>E</mi><mo>+</mo><mi>C</mi><mo>+</mo><mi>S</mi><mo>×</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">SD(E + C + S\times t)</annotation></semantics></math>
for each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p>
<p>The first step is to obtain an estimated covariance matrix for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>E</mi><mo>,</mo><mi>C</mi><mo>,</mo><mi>S</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(E, C, S)</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span>, dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E"</span>,<span class="st">"C"</span>,<span class="st">"S"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E"</span>,<span class="st">"C"</span>,<span class="st">"S"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">V</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sigma.html" class="external-link">sigma</a></span><span class="op">(</span><span class="va">cw.lmer</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>              <span class="co"># Var(E)</span></span>
<span><span class="va">V</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html" class="external-link">VarCorr</a></span><span class="op">(</span><span class="va">cw.lmer</span><span class="op">)</span><span class="op">$</span><span class="va">Chick</span>    <span class="co"># Cov(C, S)</span></span>
<span><span class="va">V</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##           E           C           S</span></span>
<span><span class="co">## E 0.1867732  0.00000000  0.00000000</span></span>
<span><span class="co">## C 0.0000000  0.15918129 -0.03977984</span></span>
<span><span class="co">## S 0.0000000 -0.03977984  0.01513793</span></span></code></pre>
<p>Now, using the matrix expression
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>a</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mi>′</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>a</mi><mi>′</mi><mi>V</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">Var(a'X) = a'Va</annotation></semantics></math>
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mi>c</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>E</mi><mo>,</mo><mi>C</mi><mo>,</mo><mi>S</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X=c(E,C,S)</annotation></semantics></math>
and a given vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>,
we can obtain the needed SDs:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">t</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">a</span> <span class="op">*</span> <span class="va">V</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sig</span>  </span></code></pre></div>
<pre class="ro"><code><span><span class="co">## [1] 0.5714931 1.0315769 1.5995606 2.1931561</span></span></code></pre>
<p>As expected, these values increase with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
Finally, we obtain the bias-adjusted estimated weights. We can use
<code>sigma = sig</code> as-is since the values follow the same ordering
as <code>cw.emm@grid</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">cw.emm</span>, type <span class="op">=</span> <span class="st">"response"</span>, bias.adj <span class="op">=</span> <span class="cn">TRUE</span>, sigma <span class="op">=</span> <span class="va">sig</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## Diet = 1:</span></span>
<span><span class="co">##  Time response    SE   df lower.CL upper.CL</span></span>
<span><span class="co">##     5     63.2  1.49 45.5     60.2     66.2</span></span>
<span><span class="co">##    10     91.1  4.11 45.8     83.0     99.5</span></span>
<span><span class="co">##    15    124.5  7.81 46.1    109.3    140.8</span></span>
<span><span class="co">##    20    163.6 12.40 46.2    139.6    189.7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diet = 2:</span></span>
<span><span class="co">##  Time response    SE   df lower.CL upper.CL</span></span>
<span><span class="co">##     5     69.3  2.15 45.0     65.1     73.7</span></span>
<span><span class="co">##    10    106.6  6.14 44.9     94.6    119.3</span></span>
<span><span class="co">##    15    152.3 12.00 44.9    129.1    177.4</span></span>
<span><span class="co">##    20    206.5 19.40 44.9    169.3    247.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diet = 3:</span></span>
<span><span class="co">##  Time response    SE   df lower.CL upper.CL</span></span>
<span><span class="co">##     5     72.8  2.20 45.0     68.4     77.3</span></span>
<span><span class="co">##    10    121.3  6.56 44.9    108.5    134.9</span></span>
<span><span class="co">##    15    182.7 13.10 44.9    157.2    210.1</span></span>
<span><span class="co">##    20    256.9 21.70 44.9    215.1    302.4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diet = 4:</span></span>
<span><span class="co">##  Time response    SE   df lower.CL upper.CL</span></span>
<span><span class="co">##     5     76.4  2.26 45.0     71.9     81.0</span></span>
<span><span class="co">##    10    119.4  6.50 45.0    106.6    132.8</span></span>
<span><span class="co">##    15    172.4 12.80 45.0    147.7    199.1</span></span>
<span><span class="co">##    20    235.5 20.80 45.0    195.5    279.2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Degrees-of-freedom method: kenward-roger </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## Intervals are back-transformed from the sqrt scale </span></span>
<span><span class="co">## Bias adjustment applied based on sigma = (various values)</span></span></code></pre>
<p>This example illustrates that it is possible to deal with random
slopes in bias corrections. However it does require some fairly careful
attention to technical details and familiarity with matrix calculations;
so if you don’t have a comfort level with those, it is best to get
outside help.</p>
<div class="section level4">
<h4 id="adding-variables-not-in-fixed-model-addl-vars">Adding variables not in fixed model {addl.vars}<a class="anchor" aria-label="anchor" href="#adding-variables-not-in-fixed-model-addl-vars"></a>
</h4>
<!-- @index `addl.vars`; Random predictors!Accessing levels -->
<p>Consider a model like</p>
<pre><code><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">subject</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mydata</span><span class="op">)</span></span></code></pre>
<p>Ordinarily, the reference grid will not include the variable
<code>x</code> because it is not part of the fixed-effects formula.
However, you can include it via the <code>addl.vars</code> argument:</p>
<pre><code><span><span class="va">EMM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, <span class="op">~</span> <span class="va">x</span><span class="op">|</span><span class="va">treatment</span>, addl.vars <span class="op">=</span> <span class="st">"x"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>We will then obtain EMMs for combinations of <code>treatment</code>
and <code>x</code>. (For a given <code>treatment</code>, all those means
will be equal for every <code>x</code>.) But the bias adjustments
<em>will</em> depend on <code>x</code>.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="offsets">Models with offsets<a class="anchor" aria-label="anchor" href="#offsets"></a>
</h2>
<!-- @index Offsets!Models with offsets; Examples!Insurance claims (SAS); `ref_grid()`!`offset` -->
<p>If a model is fitted and its formula includes an
<code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> term, then by default, the offset is computed and
included in the reference grid. To illustrate, consider a hypothetical
dataset on insurance claims (used as an <a href="https://support.sas.com/documentation/cdl/en/statug/63033/HTML/default/viewer.htm#statug_genmod_sect006.htm" class="external-link">example
in SAS’s documentation</a>). There are classes of cars of varying counts
(<code>n</code>), sizes (<code>size</code>), and age (<code>age</code>),
and we record the number of insurance claims (<code>claims</code>). We
fit a Poisson model to <code>claims</code> as a function of
<code>size</code> and <code>age</code>. An offset of <code>log(n)</code>
is included so that <code>n</code> functions as an “exposure”
variable.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1200</span>, <span class="fl">100</span>, <span class="fl">400</span>, <span class="fl">500</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="st">"M"</span>,<span class="st">"L"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    claims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">42</span>, <span class="fl">37</span>, <span class="fl">1</span>, <span class="fl">101</span>, <span class="fl">73</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ins.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">claims</span> <span class="op">~</span> <span class="va">size</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               data <span class="op">=</span> <span class="va">ins</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>First, let’s look at the reference grid obtained by default:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">ins.glm</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     size = S, M, L</span></span>
<span><span class="co">##     age = 1, 2</span></span>
<span><span class="co">##     n = 500</span></span>
<span><span class="co">## Transformation: "log"</span></span></code></pre>
<p>Note that <code>n</code> is included in the reference grid and that
its average value of 500 is displayed. But let’s look at the EMMs:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">EMM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">ins.glm</span>, <span class="st">"size"</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  size rate   SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  S    69.3 6.25 Inf     58.03      82.7</span></span>
<span><span class="co">##  M    34.6 3.34 Inf     28.67      41.9</span></span>
<span><span class="co">##  L    11.9 3.14 Inf      7.07      19.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## Intervals are back-transformed from the log scale</span></span></code></pre>
<p>We can see more explicitly what is happening by examining the
internal structure of <code>EMM</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">EMM</span><span class="op">@</span><span class="va">grid</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##   size .offset. .wgt.</span></span>
<span><span class="co">## 1    S 6.214608     2</span></span>
<span><span class="co">## 2    M 6.214608     2</span></span>
<span><span class="co">## 3    L 6.214608     2</span></span></code></pre>
<p>and note that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>500</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>≈</mo><mn>6.215</mn></mrow><annotation encoding="application/x-tex">\log(500) \approx 6.215</annotation></semantics></math>
is used as the offset value in calculating these estimates.</p>
<p>All this said, many users would like to ignore that average offset
for this kind of model, and instead use one corresponding to
<code>n = 1</code>, because then the estimates we obtain are estimated
rates per unit <code>n</code>. This may be accomplished by specifying an
<code>offset</code> parameter in the call:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">ins.glm</span>, <span class="st">"size"</span>, type <span class="op">=</span> <span class="st">"response"</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  size   rate      SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  S    0.1385 0.01250 Inf    0.1161    0.1653</span></span>
<span><span class="co">##  M    0.0693 0.00669 Inf    0.0573    0.0837</span></span>
<span><span class="co">##  L    0.0237 0.00627 Inf    0.0141    0.0398</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## Intervals are back-transformed from the log scale</span></span></code></pre>
<p>An alternative way to achieve the same results is to set
<code>n</code> equal to 1 in the reference grid itself (output not
shown, because it is identical):</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">ins.glm</span>, <span class="st">"size"</span>, type <span class="op">=</span> <span class="st">"response"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>By the way, you may set some other reference value for the rates. For
example, if you want estimates of claims per 100 cars, simply use
(results not shown):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">ins.glm</span>, <span class="st">"size"</span>, type <span class="op">=</span> <span class="st">"response"</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For more details on how offsets are handled, and how and why an
<code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> <em>model term</em> is treated differently than an
<code>offset</code> <em>argument</em> in model fitting, see <a href="xplanations.html#offsets">the “xplanations” vignette</a>.</p>
<p>An additional complication may come up in models zero-inflated or
hurdle models. In those cases, it is somewhat ambiguous what one might
mean by a “rate”, but one interpretation would be to just go with the
above techniques with estimates for just the Poisson component of the
model. Another approach would be to estimate the response mean with the
zero-inflation included, and divide by the appropriate offset. This can
be done, but it is messy. An example is given on the <a href="https://stats.stackexchange.com/questions/620842/help-interpreting-zeroinfl-results-from-emmeans/621108?noredirect=1#comment1155903_621108" class="external-link">Cross-Validated
site</a>.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="ordinal">Ordinal models<a class="anchor" aria-label="anchor" href="#ordinal"></a>
</h2>
<!-- @index Ordinal models; Examples!`wine`; Examples!Ordinal model
  Ordinal models!Latent scale -->
<p>Ordinal-response models comprise an example where several options are
available for obtaining EMMs. To illustrate, consider the
<code>wine</code> data in the <strong>ordinal</strong> package. The
response is a rating of bitterness on a five-point scale. we will
consider a probit model in two factors during fermentation:
<code>temp</code> (temperature) and <code>contact</code> (contact with
grape skins), with the judge making the rating as a scale predictor:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/runehaubo/ordinal" class="external-link">"ordinal"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: ordinal</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wine.clm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ordinal/man/clm.html" class="external-link">clm</a></span><span class="op">(</span><span class="va">rating</span> <span class="op">~</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">contact</span>, scale <span class="op">=</span> <span class="op">~</span> <span class="va">judge</span>,</span>
<span>                data <span class="op">=</span> <span class="va">wine</span>, link <span class="op">=</span> <span class="st">"probit"</span><span class="op">)</span></span></code></pre></div>
<p>(in earlier modeling, we found little interaction between the
factors.) Here are the EMMs for each factor using default options:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">wine.clm</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pairwise</span> <span class="op">~</span> <span class="va">temp</span>, <span class="va">pairwise</span> <span class="op">~</span> <span class="va">contact</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## $`emmeans of temp`</span></span>
<span><span class="co">##  temp emmean    SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  cold -0.884 0.290 Inf    -1.452    -0.316</span></span>
<span><span class="co">##  warm  0.601 0.225 Inf     0.161     1.041</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`pairwise differences of temp`</span></span>
<span><span class="co">##  1           estimate    SE  df z.ratio p.value</span></span>
<span><span class="co">##  cold - warm    -1.07 0.422 Inf  -2.547  0.0109</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`emmeans of contact`</span></span>
<span><span class="co">##  contact emmean    SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  no      -0.614 0.298 Inf   -1.1990   -0.0297</span></span>
<span><span class="co">##  yes      0.332 0.201 Inf   -0.0632    0.7264</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: temp, judge </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`pairwise differences of contact`</span></span>
<span><span class="co">##  1        estimate    SE  df z.ratio p.value</span></span>
<span><span class="co">##  no - yes   -0.684 0.304 Inf  -2.251  0.0244</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: temp, judge</span></span></code></pre>
<p>These results are on the “latent” scale; the idea is that there is a
continuous random variable (in this case normal, due to the probit link)
having a mean that depends on the predictors; and that the ratings are a
discretization of the latent variable based on a fixed set of cut points
(which are estimated). In this particular example, we also have a scale
model that says that the variance of the latent variable depends on the
judges. The latent results are quite a bit like those for measurement
data, making them easy to interpret. The only catch is that they are not
uniquely defined: we could apply a linear transformation to them, and
the same linear transformation to the cut points, and the results would
be the same.</p>
<div class="section level6">
<h6 id="ordlp"></h6>
<!-- @index Ordinal models!Linear-predictor scale -->
<p>The <code>clm</code> function actually fits the model using an
ordinary probit model but with different intercepts for each cut point.
We can get detailed information for this model by specifying
<code>mode = "linear.predictor"</code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">wine.clm</span>, mode <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span>
<span><span class="va">tmp</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     temp = cold, warm</span></span>
<span><span class="co">##     contact = no, yes</span></span>
<span><span class="co">##     judge = 1, 2, 3, 4, 5, 6, 7, 8, 9</span></span>
<span><span class="co">##     cut = multivariate response levels: 1|2, 2|3, 3|4, 4|5</span></span>
<span><span class="co">## Transformation: "probit"</span></span></code></pre>
<p>Note that this reference grid involves an additional constructed
predictor named <code>cut</code> that accounts for the different
intercepts in the model. Let’s obtain EMMs for <code>temp</code> on the
linear-predictor scale:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"temp"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  temp emmean    SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  cold  0.884 0.290 Inf     0.316     1.452</span></span>
<span><span class="co">##  warm -0.601 0.225 Inf    -1.041    -0.161</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge, cut </span></span>
<span><span class="co">## Results are given on the probit (not the response) scale. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>These are just the negatives of the latent results obtained earlier
(the sign is changed to make the comparisons go the right direction).
Closely related to this is <code>mode = "cum.prob"</code> and
<code>mode = "exc.prob"</code>, which simply transform the linear
predictor to cumulative probabilities and exceedance (1 - cumulative)
probabilities. These modes give us access to the details of the fitted
model but are cumbersome to use for describing results. When they can
become useful is when you want to work in terms of a particular cut
point. Let’s look at <code>temp</code> again in terms of the probability
that the rating will be at least 4:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">wine.clm</span>, <span class="op">~</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"exc.prob"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cut <span class="op">=</span> <span class="st">"3|4"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  temp exc.prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  cold   0.0748 0.0318 Inf    0.0124     0.137</span></span>
<span><span class="co">##  warm   0.4069 0.0706 Inf    0.2686     0.545</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
</div>
<div class="section level6">
<h6 id="ordprob"></h6>
<!-- @index Ordinal models!`prob` and `mean.class` -->
<p>There are yet more modes! With <code>mode = "prob"</code>, we obtain
estimates of the probability distribution of each rating. Its reference
grid includes a factor with the same name as the model response – in
this case <code>rating</code>. We usually want to use that as the
primary factor, and the factors of interest as <code>by</code>
variables:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">wine.clm</span>, <span class="op">~</span> <span class="va">rating</span> <span class="op">|</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## temp = cold:</span></span>
<span><span class="co">##  rating   prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  1      0.1292 0.0625 Inf   0.00667    0.2518</span></span>
<span><span class="co">##  2      0.4877 0.0705 Inf   0.34948    0.6259</span></span>
<span><span class="co">##  3      0.3083 0.0594 Inf   0.19186    0.4248</span></span>
<span><span class="co">##  4      0.0577 0.0238 Inf   0.01104    0.1043</span></span>
<span><span class="co">##  5      0.0171 0.0127 Inf  -0.00768    0.0419</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## temp = warm:</span></span>
<span><span class="co">##  rating   prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  1      0.0156 0.0129 Inf  -0.00961    0.0408</span></span>
<span><span class="co">##  2      0.1473 0.0448 Inf   0.05959    0.2350</span></span>
<span><span class="co">##  3      0.4302 0.0627 Inf   0.30723    0.5532</span></span>
<span><span class="co">##  4      0.2685 0.0625 Inf   0.14593    0.3910</span></span>
<span><span class="co">##  5      0.1384 0.0506 Inf   0.03923    0.2376</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Using <code>mode = "mean.class"</code> obtains the average of these
probability distributions as probabilities of the integers 1–5:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">wine.clm</span>, <span class="st">"temp"</span>, mode <span class="op">=</span> <span class="st">"mean.class"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  temp mean.class    SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  cold       2.35 0.144 Inf      2.06      2.63</span></span>
<span><span class="co">##  warm       3.37 0.146 Inf      3.08      3.65</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: contact, judge </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>And there is a mode for the scale model too. In this example, the
scale model involves only judges, and that is the only factor in the
grid:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">wine.clm</span>, mode <span class="op">=</span> <span class="st">"scale"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  judge response    SE  df</span></span>
<span><span class="co">##  1        1.000 0.000 Inf</span></span>
<span><span class="co">##  2        1.043 0.570 Inf</span></span>
<span><span class="co">##  3        1.053 0.481 Inf</span></span>
<span><span class="co">##  4        0.710 0.336 Inf</span></span>
<span><span class="co">##  5        0.663 0.301 Inf</span></span>
<span><span class="co">##  6        0.758 0.341 Inf</span></span>
<span><span class="co">##  7        1.071 0.586 Inf</span></span>
<span><span class="co">##  8        0.241 0.179 Inf</span></span>
<span><span class="co">##  9        0.533 0.311 Inf</span></span></code></pre>
<p>Judge 8’s ratings don’t vary much, relative to the others. The scale
model is in terms of log(SD). Again, these are not uniquely
identifiable, and the first level’s estimate is set to log(1) = 0. so,
actually, each estimate shown is a comparison with judge 1.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="mcmc">Models fitted using MCMC methods<a class="anchor" aria-label="anchor" href="#mcmc"></a>
</h2>
<!-- @index Bayesian models; Examples!Bayesian model; Examples!`cbpp`
    `rstanarm`; `hpd.summary()`; `summary()`!HPD intervals -->
<p>To illustrate <strong>emmeans</strong>’s support for models fitted
using MCMC methods, consider the <code>example_model</code> available in
the <strong>rstanarm</strong> package. The example concerns CBPP, a
serious disease of cattle in Ethiopia. A generalized linear mixed model
was fitted to the data using the code below. (This is a Bayesian
equivalent of the frequentist model we considered in the <a href="transformations.html#cbpp">“Transformations” vignette</a>.) In
fitting the model, we first set the contrast coding to
<code><a href="https://easystats.github.io/bayestestR/reference/contr.equalprior.html" class="external-link">bayestestR::contr.bayes</a></code> because this equalizes the priors
across different treatment levels (a correction from an earlier version
of this vignette.) We subsequently obtain the reference grids for these
models in the usual way. For later use, we also fit the same model with
just the prior information.
<!--- I'm faking this; I actually saved the ref_grid in a system file ---></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cbpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="fu">lme4</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/lme4/man/cbpp.html" class="external-link">cbpp</a></span>, unit <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">56</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://easystats.github.io/bayestestR/" class="external-link">"bayestestR"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"contr.bayes"</span>, <span class="st">"contr.poly"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cbpp.rstan</span> <span class="op">&lt;-</span> <span class="fu">rstanarm</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html" class="external-link">stan_glmer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">incidence</span>, <span class="va">size</span> <span class="op">-</span> <span class="va">incidence</span><span class="op">)</span> <span class="op">~</span> <span class="va">period</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">herd</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">unit</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">cbpp</span>, family <span class="op">=</span> <span class="va">binomial</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu">student_t</span><span class="op">(</span>df <span class="op">=</span> <span class="fl">5</span>, location <span class="op">=</span> <span class="fl">0</span>, scale <span class="op">=</span> <span class="fl">2</span>, autoscale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">1</span>, seed <span class="op">=</span> <span class="fl">2021.0120</span>, iter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">cbpp_prior.rstan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">cbpp.rstan</span>, prior_PD <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cbpp.rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">cbpp.rstan</span><span class="op">)</span></span>
<span><span class="va">cbpp_prior.rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">cbpp_prior.rstan</span><span class="op">)</span></span></code></pre></div>
<!--- here's the system file with the ref_grid --->
<p>Here is the structure of the reference grid:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cbpp.rg</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     period = 1, 2, 3, 4</span></span>
<span><span class="co">## Transformation: "logit"</span></span></code></pre>
<p>So here are the EMMs (no averaging needed in this simple model):</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cbpp.rg</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  period prediction lower.HPD upper.HPD</span></span>
<span><span class="co">##  1           -1.60     -2.26    -0.987</span></span>
<span><span class="co">##  2           -2.77     -3.65    -1.974</span></span>
<span><span class="co">##  3           -2.90     -3.77    -2.040</span></span>
<span><span class="co">##  4           -3.32     -4.43    -2.385</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## Results are given on the logit (not the response) scale. </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code></pre>
<p>The summary for EMMs of Bayesian models shows the median of the
posterior distribution of each estimate, along with highest posterior
density (HPD) intervals. Under the hood, the posterior sample of
parameter estimates is used to compute a corresponding sample of
posterior EMMs, and it is those that are summarized. (Technical note:
the summary is actually rerouted to the <code><a href="../reference/hpd.summary.html">hpd.summary()</a></code>
function.</p>
<div class="section level6">
<h6 id="bayesxtra"></h6>
<!-- @index `as.mcmc()`; **coda** package; **bayesplot** package; 
    **bayestestR** package; Bayes factor; Region of practical equivalence; ROPE -->
<p>We can access the posterior EMMs via the <code>as.mcmc</code> method
for <code>emmGrid</code> objects. This gives us an object of class
<code>mcmc</code> (defined in the <strong>coda</strong> package), which
can be summarized and explored as we please.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st">"coda"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: coda</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="va">cbpp.rg</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## </span></span>
<span><span class="co">## Iterations = 1:500</span></span>
<span><span class="co">## Thinning interval = 1 </span></span>
<span><span class="co">## Number of chains = 2 </span></span>
<span><span class="co">## Sample size per chain = 500 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 1. Empirical mean and standard deviation for each variable,</span></span>
<span><span class="co">##    plus standard error of the mean:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Mean     SD Naive SE Time-series SE</span></span>
<span><span class="co">## period 1 -1.595 0.3333  0.01054        0.01279</span></span>
<span><span class="co">## period 2 -2.790 0.4327  0.01368        0.01367</span></span>
<span><span class="co">## period 3 -2.916 0.4491  0.01420        0.01706</span></span>
<span><span class="co">## period 4 -3.379 0.5384  0.01703        0.01845</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 2. Quantiles for each variable:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            2.5%    25%    50%    75%   97.5%</span></span>
<span><span class="co">## period 1 -2.283 -1.823 -1.597 -1.357 -0.9929</span></span>
<span><span class="co">## period 2 -3.707 -3.038 -2.766 -2.511 -2.0197</span></span>
<span><span class="co">## period 3 -3.834 -3.196 -2.899 -2.610 -2.0915</span></span>
<span><span class="co">## period 4 -4.502 -3.725 -3.318 -3.022 -2.4079</span></span></code></pre>
<p>Note that <code>as.mcmc</code> will actually produce an
<code>mcmc.list</code> when there is more than one chain present, as in
this example. The 2.5th and 97.5th quantiles are similar, but not
identical, to the 95% confidence intervals in the frequentist
summary.</p>
<p>The <strong>bayestestR</strong> package provides <code>emmGrid</code>
methods for most of its description and testing functions. For
example:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bayestestR</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/bayestestR/reference/bayesfactor_parameters.html" class="external-link">bayesfactor_parameters</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">cbpp.rg</span><span class="op">)</span>, prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">cbpp_prior.rg</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Bayes factors might not be precise.</span></span>
<span><span class="co">##   For precise Bayes factors, sampling at least 40,000 posterior samples is recommended.</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## Bayes Factor (Savage-Dickey density ratio)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## contrast          |    BF</span></span>
<span><span class="co">## -------------------------</span></span>
<span><span class="co">## period1 - period2 |  3.02</span></span>
<span><span class="co">## period1 - period3 |  5.13</span></span>
<span><span class="co">## period1 - period4 | 17.19</span></span>
<span><span class="co">## period2 - period3 | 0.173</span></span>
<span><span class="co">## period2 - period4 | 0.268</span></span>
<span><span class="co">## period3 - period4 | 0.221</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## * Evidence Against The Null: 0</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bayestestR</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/bayestestR/reference/p_rope.html" class="external-link">p_rope</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">cbpp.rg</span><span class="op">)</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## Proportion of samples inside the ROPE [-0.25, 0.25]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## contrast          | p (ROPE)</span></span>
<span><span class="co">## ----------------------------</span></span>
<span><span class="co">## period1 - period2 |    0.021</span></span>
<span><span class="co">## period1 - period3 |    0.015</span></span>
<span><span class="co">## period1 - period4 |    0.004</span></span>
<span><span class="co">## period2 - period3 |    0.367</span></span>
<span><span class="co">## period2 - period4 |    0.184</span></span>
<span><span class="co">## period3 - period4 |    0.290</span></span></code></pre>
<p>Both of these sets of results suggest that period 1 is different from
the others. For more information on these methods, refer to <a href="https://cran.r-project.org/package=bayestestR" class="external-link">the CRAN page for
<strong>bayestestR</strong></a> and its vignettes, e.g., the one on
Bayes factors.</p>
</div>
<div class="section level3">
<h3 id="bias-adj-mcmc">Bias-adjusted incidence probabilities<a class="anchor" aria-label="anchor" href="#bias-adj-mcmc"></a>
</h3>
<!-- @index Bias adjustment!in Bayesian models -->
<p>Next, let us consider the back-transformed results. As is discussed
with the <a href="transformations.html#cbpp">frequentist model</a>,
there are random effects present, and if wee want to think in terms of
marginal probabilities across all herds and units, we should correct for
bias; and to do that, we need the standard deviations of the random
effects. The model object has MCMC results for the random effects of
each herd and each unit, but after those, there are also summary results
for the posterior SDs of the two random effects. (I used the
<code>colnames</code> function to find that they are in the 78th and
79th columns.)
<!-- We already read this in earlier, and here's the faked code --></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cbpp.sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">cbpp.rstan</span><span class="op">$</span><span class="va">stanfit</span><span class="op">)</span><span class="op">[</span>, <span class="fl">78</span><span class="op">:</span><span class="fl">79</span><span class="op">]</span></span></code></pre></div>
<p>Here are the first few:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cbpp.sigma</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##           parameters</span></span>
<span><span class="co">## iterations Sigma[unit:(Intercept),(Intercept)] Sigma[herd:(Intercept),(Intercept)]</span></span>
<span><span class="co">##       [1,]                            1.154694                         0.167807505</span></span>
<span><span class="co">##       [2,]                            1.459379                         0.040318460</span></span>
<span><span class="co">##       [3,]                            1.482619                         0.006198847</span></span>
<span><span class="co">##       [4,]                            1.236694                         0.206057981</span></span>
<span><span class="co">##       [5,]                            1.460472                         0.088491844</span></span>
<span><span class="co">##       [6,]                            1.412277                         0.070334431</span></span></code></pre>
<p>So to obtain bias-adjusted marginal probabilities, obtain the
resultant SD and regrid with bias correction:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">totSD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cbpp.sigma</span><span class="op">^</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cbpp.rgrd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regrid.html">regrid</a></span><span class="op">(</span><span class="va">cbpp.rg</span>, bias.adjust <span class="op">=</span> <span class="cn">TRUE</span>, sigma <span class="op">=</span> <span class="va">totSD</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cbpp.rgrd</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  period   prob lower.HPD upper.HPD</span></span>
<span><span class="co">##  1      0.2199    0.1324     0.322</span></span>
<span><span class="co">##  2      0.0864    0.0329     0.156</span></span>
<span><span class="co">##  3      0.0767    0.0241     0.137</span></span>
<span><span class="co">##  4      0.0524    0.0120     0.106</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code></pre>
<p>Here is a plot of the posterior incidence probabilities,
back-transformed:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-intervals.html" class="external-link">mcmc_areas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="va">cbpp.rgrd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="sophisticated_files/figure-html/unnamed-chunk-37-1.png" alt="kernel denity estimates for each of the 4 periods. Their medians and spreads decrease with period, and period 1 is especially different. See the previous summary table for the numerical values of the estimated means" width="432"></p>
<p>… and here are intervals for each period compared with its
neighbor:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/contrast.html">contrast</a></span><span class="op">(</span><span class="va">cbpp.rgrd</span>, <span class="st">"consec"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  contrast          estimate lower.HPD upper.HPD</span></span>
<span><span class="co">##  period1 - period2  0.13283    0.0280     0.235</span></span>
<span><span class="co">##  period2 - period3  0.00918   -0.0635     0.097</span></span>
<span><span class="co">##  period3 - period4  0.02331   -0.0427     0.103</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code></pre>
<p>The only interval that excludes zero is the one that compares periods
1 and 2.</p>
</div>
<div class="section level3">
<h3 id="predict-mcmc">Bayesian prediction<a class="anchor" aria-label="anchor" href="#predict-mcmc"></a>
</h3>
<!-- @index Predictions!Bayesian models; 
            Predictions!Posterior predictive distribution -->
<p>To predict from an MCMC model, just specify the
<code>likelihood</code> argument in <code>as.mcmc</code>. Doing so
causes the function to simulate data from the posterior predictive
distribution. For example, if we want to predict the CBPP incidence in
future herds of 25 cattle, we can do:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2019.0605</span><span class="op">)</span></span>
<span><span class="va">cbpp.preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="va">cbpp.rgrd</span>, likelihood <span class="op">=</span> <span class="st">"binomial"</span>, trials <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_hist</a></span><span class="op">(</span><span class="va">cbpp.preds</span>, binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="sophisticated_files/figure-html/unnamed-chunk-39-1.png" alt="Histograms of the predictive distributions for each period. The one for period 1 has bins from 0 to 15; the number of bins decreases until period 4 has only bins for 0 through 5." width="432"></p>
<p><a href="#contents">Back to Contents</a></p>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell V. Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
