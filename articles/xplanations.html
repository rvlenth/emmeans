<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="emmeans">
<title>Explanations supplement • emmeans</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Explanations supplement">
<meta property="og:description" content="emmeans">
<meta property="og:image" content="https://rvlenth.github.io/emmeans/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">emmeans</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/AQuickStart.html">Quick start guide for **emmeans**</a>
    <a class="dropdown-item" href="../articles/basics.html">Basics of estimated marginal means</a>
    <a class="dropdown-item" href="../articles/comparisons.html">Comparisons and contrasts in emmeans</a>
    <a class="dropdown-item" href="../articles/confidence-intervals.html">Confidence intervals and tests in emmeans</a>
    <a class="dropdown-item" href="../articles/FAQs.html">FAQs for emmeans</a>
    <a class="dropdown-item" href="../articles/interactions.html">Interaction analysis in emmeans</a>
    <a class="dropdown-item" href="../articles/messy-data.html">Working with messy data</a>
    <a class="dropdown-item" href="../articles/models.html">Models supported by emmeans</a>
    <a class="dropdown-item" href="../articles/predictions.html">Prediction in **emmeans**</a>
    <a class="dropdown-item" href="../articles/re-engineering-clds.html">Re-engineering CLDs</a>
    <a class="dropdown-item" href="../articles/sophisticated.html">Sophisticated models in emmeans</a>
    <a class="dropdown-item" href="../articles/transformations.html">Transformations and link functions in emmeans</a>
    <a class="dropdown-item" href="../articles/utilities.html">Utilities and options for emmeans</a>
    <a class="dropdown-item" href="../articles/vignette-topics.html">Index of vignette topics</a>
    <a class="dropdown-item" href="../articles/xplanations.html">Explanations supplement</a>
    <a class="dropdown-item" href="../articles/xtending.html">For developers: Extending **emmeans**</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rvlenth/emmeans/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Explanations supplement</h1>
                        <h4 data-toc-skip class="author">emmeans
package, Version 1.10.3</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/emmeans/blob/HEAD/vignettes/xplanations.Rmd" class="external-link"><code>vignettes/xplanations.Rmd</code></a></small>
      <div class="d-none name"><code>xplanations.Rmd</code></div>
    </div>

    
    
<!-- @index Vignettes!Explanations supplement -->
<p>This vignette provides additional documentation for some methods
implemented in the <strong>emmeans</strong> package.</p>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
<div class="section level2">
<h2 id="contents">Contents<a class="anchor" aria-label="anchor" href="#contents"></a>
</h2>
<ol style="list-style-type: decimal">
<li><a href="#submodels">Sub-models</a></li>
<li><a href="#arrows">Comparison arrows</a></li>
<li><a href="#joint_tests">Confounded effects in joint tests</a></li>
<li><a href="#offsets">Intricacies of offsets</a></li>
</ol>
</div>
<div class="section level2">
<h2 id="submodels">Sub-models<a class="anchor" aria-label="anchor" href="#submodels"></a>
</h2>
<!-- @index `submodel`; Alias matrix; EMMs!Projecting to a submodel; 
             Constrained marginal means -->
<p>Estimated marginal means (EMMs) and other statistics computed by the
<strong>emmeans</strong> package are <em>model-based</em>: they depend
on the model that has been fitted to the data. In this section we
discuss a provision whereby a different underlying model may be
considered. The <code>submodel</code> option in <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code>
can project EMMs and other statistics to an alternative universe where a
simpler version of the model has been fitted to the data. Another way of
looking at this is that it constrains certain external effects to be
zero – as opposed to averaging over them as is otherwise done for
marginal means.</p>
<p>Two things to know before getting into details:</p>
<ol style="list-style-type: decimal">
<li>The <code>submodel</code> option uses information from the
fixed-effects portion of the model matrix</li>
<li>Not all model classes are supported for the <code>submodel</code>
option.</li>
</ol>
<p>Now some details. Suppose that we have a fixed-effects model matrix
<span class="math inline">\(X\)</span>, and let <span class="math inline">\(X_1\)</span> denote a sub-matrix of <span class="math inline">\(X\)</span> whose columns correspond to a specified
sub-model. (Note: if there are weights, use <span class="math inline">\(X = W^{1/2}X^*\)</span>, where <span class="math inline">\(X^*\)</span> is the model matrix without the
weights incorporated.) The trick we use is what is called the <em>alias
matrix</em>: <span class="math inline">\(A =
(X_1'X_1)^-X_1'X\)</span> where <span class="math inline">\(Z^-\)</span> denotes a generalized inverse of
<span class="math inline">\(Z\)</span>. It can be shown that <span class="math inline">\((X_1'X_1)^-X_1' =
A(X'X)^-X'\)</span>; thus, in an ordinary fixed-effects
regression model, <span class="math inline">\(b_1 = Ab\)</span> where
<span class="math inline">\(b_1\)</span> and <span class="math inline">\(b\)</span> denote the regression coefficients for
the sub-model and full model, respectively. Thus, given a matrix <span class="math inline">\(L\)</span> such that <span class="math inline">\(Lb\)</span> provides estimates of interest for the
full model, the corresponding estimates for the sub-model are <span class="math inline">\(L_1b_1\)</span>, where <span class="math inline">\(L_1\)</span> is the sub-matrix of <span class="math inline">\(L\)</span> consisting of the columns corresponding
to the columns of <span class="math inline">\(X_1\)</span>. Moreover,
<span class="math inline">\(L_1b_1 = L_1(Ab) = (L_1A)b\)</span>; that
is, we can replace <span class="math inline">\(L\)</span> by <span class="math inline">\(L_1A\)</span> to obtain estimates from the
sub-model. That’s all that <code>update(..., submodel = ...)</code>
does.</p>
<p>Here are some intuitive observations:</p>
<ol style="list-style-type: decimal">
<li>Consider the excluded effects, <span class="math inline">\(X_2\)</span>, consisting of the columns of <span class="math inline">\(X\)</span> other than <span class="math inline">\(X_1\)</span>. The corresponding columns of the
alias matrix are regression coefficients treating <span class="math inline">\(X_2\)</span> as the response and <span class="math inline">\(X_1\)</span> as the predictors.</li>
<li>Thus, when we obtain predictions via these aliases, we are
predicting the effects of <span class="math inline">\(X_2\)</span> based
on <span class="math inline">\(X_1\)</span>.</li>
<li>The columns of the new linear predictor <span class="math inline">\(\tilde L = L_1A\)</span> depend only on the
columns of <span class="math inline">\(L_1\)</span>, and hence not on
other columns of <span class="math inline">\(L\)</span>.</li>
</ol>
<p>These three points provide three ways of saying nearly the same
thing, namely that we are excluding the effects in <span class="math inline">\(X_2\)</span>. Note that in a rank-deficient
situation, there are different possible generalized inverses, and so in
(1), <span class="math inline">\(A\)</span> is not unique. However, the
predictions in (2) are unique. In ordinary regression models, (1), (2),
and (3) all apply and will be the same as predictions from re-fitting
the model with model matrix <span class="math inline">\(X_1\)</span>;
however, in generalized linear models, mixed models, etc., re-fitting
will likely produce somewhat different results. That is because fitting
such models involves iterative weighting, and the re-fitted models will
probably not have the same weights. However, point (3) will still hold:
the predictions obtained with a submodel will involve only the columns
of <span class="math inline">\(L_1\)</span> and hence constrain all
effects outside of the sub-model to be zero. Therefore, when it really
matters to get the correct estimates from the stated sub-model, the user
should actually fit that sub-model unless the full model is an ordinary
linear regression.</p>
<p>A technicality: Most writers define the alias matrix as <span class="math inline">\((X_1'X_1)^-X_1'X_2\)</span>, where <span class="math inline">\(X_2\)</span> denotes that part of <span class="math inline">\(X\)</span> that excludes the columns of <span class="math inline">\(X_1\)</span>. We are including all columns of
<span class="math inline">\(X\)</span> here just because it makes the
notation very simple; the <span class="math inline">\(X_1\)</span>
portion of <span class="math inline">\(X\)</span> just reduces to the
identity (at least in the case where <span class="math inline">\(X_1\)</span> is full-rank).</p>
<p>A word on computation: Like many matrix expressions, we do not
compute <span class="math inline">\(A\)</span> directly as shown.
Instead, we use the QR decomposition of <span class="math inline">\(X_1\)</span>, obtainable via the R call
<code>Z &lt;- qr(X1)</code>. Then the alias matrix is computed via
<code>A &lt;- qr.coef(Z, X)</code>. In fact, nothing changes if we use
just the <span class="math inline">\(R\)</span> portion of <span class="math inline">\(X = QR\)</span>, saving us both memory and
computational effort. The exported function <code><a href="../reference/extending-emmeans.html">.cmpMM()</a></code>
extracts this <span class="math inline">\(R\)</span> matrix, taking care
of any pivoting that might have occurred. And in an <code>lm</code>
object, the QR decomposition of <span class="math inline">\(X\)</span>
is already saved as a slot. The <code><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr.coef()</a></code> function works
just fine in both the full-rank and rank-deficient cases, but in the
latter situation, some elements of <code>A</code> will be
<code>NA</code>; those correspond to “excluded” predictors, but that is
another way of saying that we are constraining their regression
coefficients to be zero. Thus, we can easily clean that up via
<code>A[is.na(A)] &lt;- 0</code>.</p>
<p>If we specify <code>submodel = "minimal"</code>, the software figures
out the sub-model by extracting terms involving only factors that have
not already been averaged over. If the user specifies
<code>submodel = "type2"</code>, an additional step is performed: Let
<span class="math inline">\(X_1\)</span> have only the highest-order
effect in the minimal model, and <span class="math inline">\(X_0\)</span> denote the matrix of all columns of
<span class="math inline">\(X\)</span> whose columns do not contain the
effect in <span class="math inline">\(X_1\)</span>. We then replace
<span class="math inline">\(Z\)</span> by the QR decomposition of <span class="math inline">\([I - X_0(X_0'X_0)^-X_0']X_1^*\)</span>.
This projects <span class="math inline">\(X_1^*\)</span> onto the null
space of <span class="math inline">\(X_0\)</span>. The net result is
that we obtain estimates of just the <span class="math inline">\(X_1^*\)</span> effects, after adjusting for all
effects that don’t contain it (including the intercept if present). Such
estimates have very limited use in data description, but provide a kind
of “Type II” analysis when used in conjunction with
<code><a href="../reference/joint_tests.html">joint_tests()</a></code>. The <code>"type2"</code> calculations
parallel those <a href="https://documentation.sas.com/?docsetId=statug&amp;docsetTarget=statug_introglmest_sect011.htm&amp;docsetVersion=14.3&amp;locale=en" class="external-link">documented
by SAS</a> for obtaining type II estimable functions in SAS
<code>PROC GLM</code>. However, we (as well as
<code><a href="https://rdrr.io/pkg/car/man/Anova.html" class="external-link">car::Anova()</a></code>) define “contained” effects differently from
SAS, treating covariates no differently than factors.</p>
<div class="section level3">
<h3 id="mult-submodel">A note on multivariate models<a class="anchor" aria-label="anchor" href="#mult-submodel"></a>
</h3>
<!-- @index `submodel`!in a multivariate model; 
            Multivariate models!with `submodel` -->
<p>Recall that <strong>emmeans</strong> generates a constructed factor
for the levels of a multivariate response. That factor (or factors) is
completely ignored in any sub-model calculations. The <span class="math inline">\(X\)</span> and <span class="math inline">\(X_1\)</span> matrices described above involve only
the predictors in the right-hand side of the model equation . The
multivariate response “factor” implicitly interacts with everything in
the right-hand-side model; and the same is true of any sub-model. So it
is not possible to consider sub-models where terms are omitted from
among those multivariate interactions (note that it is also impossible
to fit a multivariate sub-model that excludes those interactions). The
only way to remove consideration of multivariate effects is to average
over them via a call to <code><a href="../reference/emmeans.html">emmeans()</a></code>.</p>
<p><a href="#contents">Back to Contents</a></p>
<!-- This section is a rewrite of an answer I provided on Stack Overflow,
  https://stackoverflow.com/questions/61779348/how-does-emmeans-calculate-confidence-intervals-used-to-compare-means/61822331#61822331 -->
</div>
</div>
<div class="section level2">
<h2 id="arrows">Comparison arrows<a class="anchor" aria-label="anchor" href="#arrows"></a>
</h2>
<!-- @index Comparisons!Graphical!How arrows are determined;
            Comparison arrows!Derivation -->
<p>The <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for <code>emmGrid</code> objects
offers the option <code>comparisons = TRUE</code>. If used, the software
attempts to construct “comparison arrows” whereby two estimated marginal
means (EMMs) differ significantly if, and only if, their respective
comparison arrows do not overlap. In this section, we explain how these
arrows are obtained.</p>
<p>First, please understand these comparison arrows are decidedly
<em>not</em> the same as confidence intervals. Confidence intervals for
EMMs are based on the statistical properties of the individual EMMs,
whereas comparison arrows are based on the statistical properties of
<em>differences</em> of EMMs.</p>
<p>Let the EMMs be denoted <span class="math inline">\(m_1, m_2, ...,
m_k\)</span>. For simplicity, let us assume that these are ordered:
<span class="math inline">\(m_1 \le m_2 \le \cdots \le m_k\)</span>. Let
<span class="math inline">\(d_{ij} = m_j - m_i\)</span> denote the
difference between the <span class="math inline">\(i\)</span>th and
<span class="math inline">\(j\)</span>th EMM. Then the <span class="math inline">\((1 - \alpha)\)</span> confidence interval for the
true difference <span class="math inline">\(\delta_{ij} = \mu_j -
\mu_i\)</span> is <span class="math display">\[  d_{ij} -
e_{ij}\quad\mbox{to}\quad d_{ij} + e_{ij} \]</span> where <span class="math inline">\(e_{ij}\)</span> is the “margin of error” for the
difference; i.e., <span class="math inline">\(e_{ij} = t\cdot
SE(d_{ij})\)</span> for some critical value <span class="math inline">\(t\)</span> (equal to <span class="math inline">\(t_{\alpha/2}\)</span> when no multiplicity
adjustment is used). Note that <span class="math inline">\(d_{ij}\)</span> is statistically significant if,
and only if, <span class="math inline">\(d_{ij} &gt;
e_{ij}\)</span>.</p>
<p>Now, how to get the comparison arrows? These arrows are plotted with
origins at the <span class="math inline">\(m_i\)</span>; we have an
arrow of length <span class="math inline">\(L_i\)</span> pointing to the
left, and an arrow of length <span class="math inline">\(R_i\)</span>
pointing to the right. To compare EMMs <span class="math inline">\(m_i\)</span> and <span class="math inline">\(m_j\)</span> (and remembering that we are
supposing that <span class="math inline">\(m_i \le m_j\)</span>), we
propose to look to see if the arrows extending right from <span class="math inline">\(m_i\)</span> and left from <span class="math inline">\(m_j\)</span> overlap or not. So, ideally, if we
want overlap to be identified with statistical non-significance, we want
<span class="math display">\[    R_i + L_j = e_{ij}   \quad\mbox{for all
} i &lt; j \]</span></p>
<p>If we can do that, then the two arrows will overlap if, and only if,
<span class="math inline">\(d_{ij} &lt; e_{ij}\)</span>.</p>
<p>This is easy to accomplish if all the <span class="math inline">\(e_{ij}\)</span> are equal: just set all <span class="math inline">\(L_i = R_j = \frac12e_{12}\)</span>. But with
differing <span class="math inline">\(e_{ij}\)</span> values, it may or
may not even be possible to obtain suitable arrow lengths.</p>
<p>The code in <strong>emmeans</strong> uses an <em>ad hoc</em> weighted
regression method to solve the above equations. We give greater weights
to cases where <span class="math inline">\(d_{ij}\)</span> is close to
<span class="math inline">\(e_{ij}\)</span>, because those are the cases
where it is more critical that we get the lengths of the arrows right.
Once the regression equations are solved, we test to make sure that
<span class="math inline">\(R_i + L_j &lt; d_{ij}\)</span> when the
difference is significant, and <span class="math inline">\(\ge
d_{ij}\)</span> when it is not. If one or more of those checks fails, a
warning is issued.</p>
<p>That’s the essence of the algorithm. Note, however, that there are a
few complications that need to be handled:</p>
<ul>
<li>For the lowest EMM <span class="math inline">\(m_1\)</span>, <span class="math inline">\(L_1\)</span> is completely arbitrary because there
are no right-pointing arrows with which to compare it; in fact, we don’t
even need to display that arrow. The same is true of <span class="math inline">\(R_k\)</span> for the largest EMM <span class="math inline">\(m_k\)</span>. Moreover, there could be additional
unneeded arrows when other <span class="math inline">\(m_i\)</span> are
equal to <span class="math inline">\(m_1\)</span> or <span class="math inline">\(m_k\)</span>.</li>
<li>Depending on the number <span class="math inline">\(k\)</span> of
EMMs and the number of tied minima and maxima, the system of equations
could be under-determined, over-determined, or just right.</li>
<li>It is possible that the solution could result in some <span class="math inline">\(L_i\)</span> or <span class="math inline">\(R_j\)</span> being negative. That would result in
an error.</li>
</ul>
<p>In summary, the algorithm does not always work (in fact it is
possible to construct cases where no solution is possible). But we try
to do the best we can. The main reason for trying to do this is to
encourage people to not ever use confidence intervals for the <span class="math inline">\(m_i\)</span> as a means of testing the comparisons
<span class="math inline">\(d_{ij}\)</span>. That is almost always
incorrect.</p>
<p>What is better yet is to simply avoid using comparison arrows
altogether and use <code><a href="../reference/pwpp.html">pwpp()</a></code> or <code><a href="../reference/pwpm.html">pwpm()</a></code> to display
the <em>P</em> values directly.</p>
<div class="section level3">
<h3 id="examples-and-tests">Examples and tests<a class="anchor" aria-label="anchor" href="#examples-and-tests"></a>
</h3>
<p>Here is a constructed example with specified means and somewhat
unequal SEs</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.1</span>, <span class="fl">4.5</span>, <span class="fl">5.4</span>,    <span class="fl">6.3</span>, <span class="fl">5.5</span>, <span class="fl">6.7</span><span class="op">)</span></span>
<span><span class="va">se2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="fl">.4</span>, <span class="fl">.37</span>,  <span class="fl">.41</span>, <span class="fl">.23</span>, <span class="fl">.48</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">lev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a1"</span>,<span class="st">"a2"</span>,<span class="st">"a3"</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b1"</span>, <span class="st">"b2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">foo</span> <span class="op">=</span> <span class="fu"><a href="../reference/emmobj.html">emmobj</a></span><span class="op">(</span><span class="va">m</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">se2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="va">lev</span>, linfct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">foo</span>, CIs <span class="op">=</span> <span class="cn">FALSE</span>, comparisons <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="xplanations_files/figure-html/unnamed-chunk-2-1.png" alt="Plot A: Comparison arrows for foo. These arrows overlap or not as per the P-values in pairs(foo) are greater or less than 0.05" width="432"></p>
<p>This came out pretty well. But now let’s keep the means and SEs the
same but make them correlated. Such correlations happen, for example, in
designs with subject effects. The function below is used to set a
specified intra-class correlation, treating <code>A</code> as a
within-subjects (or split-plot) factor and <code>B</code> as a
between-subjects (whole-plot) factor. We’ll start with a correlation of
0.3.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mkmat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">V</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">indexes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">indexes</span><span class="op">)</span></span>
<span>        <span class="va">V</span><span class="op">[</span><span class="va">i</span>,<span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sd</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">rho</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">sd</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">sd</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">V</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Intraclass correlation = 0.3</span></span>
<span><span class="va">foo3</span> <span class="op">=</span> <span class="va">foo</span></span>
<span><span class="va">foo3</span><span class="op">@</span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu">mkmat</span><span class="op">(</span><span class="va">foo3</span><span class="op">@</span><span class="va">V</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">foo3</span>, CIs <span class="op">=</span> <span class="cn">FALSE</span>, comparisons <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="xplanations_files/figure-html/unnamed-chunk-3-1.png" alt="Plot B - for foo3. The arrow lengths are more diverse than in plot A, but the arrows still all work correctly" width="432"></p>
<p>Same with intraclass correlation of 0.6:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo6</span> <span class="op">=</span> <span class="va">foo</span></span>
<span><span class="va">foo6</span><span class="op">@</span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu">mkmat</span><span class="op">(</span><span class="va">foo6</span><span class="op">@</span><span class="va">V</span>, <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">foo6</span>, CIs <span class="op">=</span> <span class="cn">FALSE</span>, comparisons <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre class="re"><code><span><span class="co">## Warning: Comparison discrepancy in group "1", a1 b1 - a2 b2:</span></span>
<span><span class="co">##     Target overlap = 0.443, overlap on graph = -0.2131</span></span></code></pre>
<p><img src="xplanations_files/figure-html/unnamed-chunk-4-1.png" alt="Plot C - for foo6. Not all of the arrows work correctly and we get a warning message with details. The appearance of the arrows is pretty chaotic, with many extending in vastly unequal distances from the means" width="432"></p>
<p>Now we have a warning that some arrows don’t overlap, but should. We
can make it even worse by upping the correlation to 0.8:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo8</span> <span class="op">=</span> <span class="va">foo</span></span>
<span><span class="va">foo8</span><span class="op">@</span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu">mkmat</span><span class="op">(</span><span class="va">foo8</span><span class="op">@</span><span class="va">V</span>, <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">foo8</span>, CIs <span class="op">=</span> <span class="cn">FALSE</span>, comparisons <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre class="re"><code><span><span class="co">## Error: Aborted -- Some comparison arrows have negative length!</span></span>
<span><span class="co">## (in group "1")</span></span></code></pre>
<p>Now the solution actually leads to negative arrow lengths.</p>
<p>What is happening here is we are continually reducing the SE of
within-B comparisons while keeping the others the same. These all work
out if we use <code>B</code> as a <code>by</code> variable:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">foo8</span>, CIs <span class="op">=</span> <span class="cn">FALSE</span>, comparisons <span class="op">=</span> <span class="cn">TRUE</span>, by <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span></code></pre></div>
<p><img src="xplanations_files/figure-html/unnamed-chunk-6-1.png" alt="Plot D - foo8, separate panels for each B. This is a nicely behaved plot because we are not mixing together between-B and within-B SEs." width="432"></p>
<p>Note that the lengths of the comparison arrows are relatively equal
within the levels of <code>B</code>. Or, we can use <code><a href="../reference/pwpp.html">pwpp()</a></code>
or <code><a href="../reference/pwpm.html">pwpm()</a></code> to show the <em>P</em> values for all comparisons
among the six means:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pwpp.html">pwpp</a></span><span class="op">(</span><span class="va">foo6</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="xplanations_files/figure-html/unnamed-chunk-7-1.png" alt="pwpp of foo6, providing a fairly readable display of the P-values in pairs(foo6)" width="432"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pwpm.html">pwpm</a></span><span class="op">(</span><span class="va">foo6</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##       a1 b1  a2 b1  a3 b1  a1 b2  a2 b2  a3 b2</span></span>
<span><span class="co">## a1 b1 [6.1] &lt;.0001 0.1993 0.9988 0.6070 0.8972</span></span>
<span><span class="co">## a2 b1   1.6  [4.5] 0.0958 0.0208 0.2532 0.0057</span></span>
<span><span class="co">## a3 b1   0.7   -0.9  [5.4] 0.5788 0.9999 0.2641</span></span>
<span><span class="co">## a1 b2  -0.2   -1.8   -0.9  [6.3] 0.1439 0.9204</span></span>
<span><span class="co">## a2 b2   0.6   -1.0   -0.1    0.8  [5.5] 0.0245</span></span>
<span><span class="co">## a3 b2  -0.6   -2.2   -1.3   -0.4   -1.2  [6.7]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Row and column labels: A:B</span></span>
<span><span class="co">## Upper triangle: P values   adjust = "tukey"</span></span>
<span><span class="co">## Diagonal: [Estimates] (estimate) </span></span>
<span><span class="co">## Lower triangle: Comparisons (estimate)   earlier vs. later</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="related-reading-on-comparisons">Related reading on comparisons<a class="anchor" aria-label="anchor" href="#related-reading-on-comparisons"></a>
</h3>
<p>The following reference (as well as some articles referenced therein)
have been suggested to me as relating to similar issues:</p>
<p>Franz, V.H., Loftus, G.R. (2012) Standard errors and confidence
intervals in within-subjects designs: Generalizing Loftus and Masson
(1994) and avoiding the biases of alternative accounts. <em>Psychonomic
Bulletin and Review</em> <strong>19</strong>, 395-–404. <a href="https://doi.org/10.3758/s13423-012-0230-1" class="external-link uri">https://doi.org/10.3758/s13423-012-0230-1</a></p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="joint_tests">Confounded effects in joint tests<a class="anchor" aria-label="anchor" href="#joint_tests"></a>
</h2>
<!-- @index Confounded effects; `joint_tests()`!Confounded effects;
       Rank deficiency; Missing cells;  Estimable functions -->
<p>When a design has empty cells, this creates estimability issues; and
in the context of <code><a href="../reference/joint_tests.html">joint_tests()</a></code>, this means that certain
main- and interaction effects cannot be estimated, leading to reduced
degrees of freedom in the joint tests. Instead, the estimable parts of
these lost effects are pooled together into a set of contrasts labeled
<code>(confounded)</code> in the output (as long as
<code>showconf = TRUE</code>). Here is a simple illustration based on
the <code>warpbreaks</code> dataset with the last cell removed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span><span class="op">)</span><span class="op">)</span>   <span class="co">## ensure system default</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">warpbreaks</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, <span class="op">]</span>   <span class="co">### no data for (wool = B, tension = H)</span></span>
<span><span class="va">w.lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">breaks</span> <span class="op">~</span> <span class="va">wool</span> <span class="op">*</span> <span class="va">tension</span>, data <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">w.rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">w.lm</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">jt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/joint_tests.html">joint_tests</a></span><span class="op">(</span><span class="va">w.rg</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  model term   df1 df2 F.ratio p.value note</span></span>
<span><span class="co">##  tension        1  35   6.064  0.0189    e</span></span>
<span><span class="co">##  wool:tension   1  35   3.740  0.0613    e</span></span>
<span><span class="co">##  (confounded)   2  35   2.266  0.1187     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## e: df1 reduced due to non-estimability</span></span></code></pre>
<p>With no empty cells, we would have had 1 d.f. for <code>wool</code>,
2 d.f. for <code>tension</code>, and 2 d.f. for
<code>wool:tension</code>, for a total of 5 d.f. (6 cells, 6 - 1 = 5
d.f. for contrasts among them). With the missing cell, we can estimate
only 5 - 1 = 4 d.f. worth of effects, and the <code>(confounding)</code>
part accounts for 2 of them that are not purely main effects nor
interaction effects.</p>
<p>How do we obtain these extra 2 d.f.? Well, first of all, it is easy
to obtain a joint test of <em>all</em> comparisons among the cell
means</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">test.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summary.emmGrid.html">test</a></span><span class="op">(</span><span class="fu"><a href="../reference/contrast.html">contrast</a></span><span class="op">(</span><span class="va">w.rg</span>, <span class="st">"consec"</span><span class="op">)</span>, joint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  df1 df2 F.ratio p.value note</span></span>
<span><span class="co">##    4  35   4.332  0.0060    e</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## e: df1 reduced due to non-estimability</span></span></code></pre>
<p>What we do is simply pool together all the contrasts that were tested
in <code>jt</code>, and compare them with the above. To do this, we
obtain the estimable functions associated with <code>jt</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">ef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">jt</span>, <span class="st">"est.fcns"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## $tension</span></span>
<span><span class="co">##      (Intercept) woolB  tensionM tensionH woolB:tensionM woolB:tensionH</span></span>
<span><span class="co">## [1,]           0     0 0.8944272        0      0.4472136              0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`wool:tension`</span></span>
<span><span class="co">##      (Intercept) woolB tensionM tensionH woolB:tensionM woolB:tensionH</span></span>
<span><span class="co">## [1,]           0     0        0        0              1              0</span></span></code></pre>
<p>Then we can get a joint test of all these together via some
trickery:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">w.rg</span></span>
<span><span class="va">tmp</span><span class="op">@</span><span class="va">linfct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">ef</span><span class="op">)</span>      <span class="co"># combine EFs into a matrix</span></span>
<span><span class="va">tmp</span><span class="op">@</span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">@</span><span class="va">grid</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span>           <span class="co"># replace the @linfct and @grid slots</span></span>
<span><span class="op">(</span><span class="va">test.ef</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summary.emmGrid.html">test</a></span><span class="op">(</span><span class="va">tmp</span>, joint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  <span class="co">#  -- that's enough to get the test</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  df1 df2 F.ratio p.value</span></span>
<span><span class="co">##    2  35   6.398  0.0043</span></span></code></pre>
<p>(Note: In case this isn’t obvious, we couldn’t have just pooled
together the F ratios for those effects, because they are type-III tests
which are not necessarily independent.) So now we have
<code>test.all</code> with the 4 d.f. worth of all effects comparing the
cells, and <code>test.ef</code> with just the effects in the top part of
the <code>jt</code> table. We can get the unexplained part of
<code>test.all</code> by d.f.-weighted subtraction:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">test.all</span><span class="op">$</span><span class="va">df1</span> <span class="op">*</span> <span class="va">test.all</span><span class="op">$</span><span class="va">F.ratio</span>  <span class="op">-</span>  <span class="va">test.ef</span><span class="op">$</span><span class="va">df1</span> <span class="op">*</span> <span class="va">test.ef</span><span class="op">$</span><span class="va">F.ratio</span><span class="op">)</span> <span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">test.all</span><span class="op">$</span><span class="va">df1</span> <span class="op">-</span> <span class="va">test.ef</span><span class="op">$</span><span class="va">df1</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## [1] 2.266</span></span></code></pre>
<p>This gives us the <code>F.ratio</code> shown in the
<code>(confounded)</code> row of the <code>jt</code> results above.
That’s all there is to it!</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="offsets">Intricacies of offsets<a class="anchor" aria-label="anchor" href="#offsets"></a>
</h2>
<!-- @index Offsets!`offset()` term vs. `offset` argument in model;
     Examples!`Insurance`              -->
<p>Many model-fitting functions provide two ways of specifying model
offsets: in the model formula, or in a separate <code>offset</code>
argument. The purpose of this section is to discuss how to deal with
these in <strong>emmeans</strong>, and in particular, why we decided to
handle them differently, even though they seem equivalent.</p>
<p>To illustrate, consider the following two models:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="va">District</span> <span class="op">+</span> <span class="va">Group</span> <span class="op">+</span> <span class="va">Age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Holders</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">Insurance</span>,</span>
<span>            family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span></span>
<span><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="va">District</span> <span class="op">+</span> <span class="va">Group</span> <span class="op">+</span> <span class="va">Age</span>,</span>
<span>            offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Holders</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">Insurance</span>, </span>
<span>            family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span></span></code></pre></div>
<p>Both models specify, in different ways, an offset of
<code>log(Holders)</code>; and they both have the same regression
coefficients and fitted values.</p>
<p>We do not treat these two models in the same way in
<strong>emmeans</strong>. In <code>mod1</code>, the offset is out there
as part of the model formula, and so it is treated as such in making
predictions: the linear prediction includes the term
<code>log(Holders)</code>, with a regression coefficient of 1. In
<code>mod2</code>, the model formula does not include the variable
<code>Holders</code>, so we don’t use it as a predictor. Instead, we
regard the <code>offset</code> argument as implying that there is a
covariate that is computed in advance of fitting the model, and
constrained to have a regression coefficient of 1. Let’s see how this
plays out by looking at the reference grids:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">rg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     District = 1, 2, 3, 4</span></span>
<span><span class="co">##     Group = &lt;1l, 1-1.5l, 1.5-2l, &gt;2l</span></span>
<span><span class="co">##     Age = &lt;25, 25-29, 30-35, &gt;35</span></span>
<span><span class="co">##     Holders = 364.98</span></span>
<span><span class="co">## Transformation: "log"</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">rg2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     District = 1, 2, 3, 4</span></span>
<span><span class="co">##     Group = &lt;1l, 1-1.5l, 1.5-2l, &gt;2l</span></span>
<span><span class="co">##     Age = &lt;25, 25-29, 30-35, &gt;35</span></span>
<span><span class="co">##     .static.offset. = 4.9042</span></span>
<span><span class="co">## Transformation: "log"</span></span></code></pre>
<p>The distinction is in the fourth predictor – in <code>mod1</code>, it
is <code>Holders</code>, and in <code>mod2</code>, it is a generated
covariate named <code>.static.offset.</code>. (We call it a “static”
offset because does not depend on model predictors, whereas
<code>mod1</code> could be regarded as having a dynamic offset.) In
either case, that fourth variable is set to its mean by default.</p>
<p>Now let’s compare some EMMs:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">rg1</span>, <span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Age   emmean     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  &lt;25     4.43 0.0686 Inf      4.30      4.57</span></span>
<span><span class="co">##  25-29   4.24 0.0522 Inf      4.14      4.34</span></span>
<span><span class="co">##  30-35   4.09 0.0493 Inf      3.99      4.18</span></span>
<span><span class="co">##  &gt;35     3.90 0.0264 Inf      3.84      3.95</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: District, Group </span></span>
<span><span class="co">## Results are given on the log (not the response) scale. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">rg2</span>, <span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Age   emmean     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  &lt;25     3.44 0.0686 Inf      3.30      3.57</span></span>
<span><span class="co">##  25-29   3.25 0.0522 Inf      3.14      3.35</span></span>
<span><span class="co">##  30-35   3.09 0.0493 Inf      2.99      3.19</span></span>
<span><span class="co">##  &gt;35     2.90 0.0264 Inf      2.85      2.95</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: District, Group </span></span>
<span><span class="co">## Results are given on the log (not the response) scale. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>We don’t get the same estimates. That is because in <code>mod1</code>
(<code>rg1</code>), the offset that is added is <span class="math inline">\(\log\text{Holders} = \log{364.98} \approx
5.90\)</span>, while in <code>mod2</code> (<code>rg2</code>), the added
offset is <span class="math inline">\(\text{.static.offset.} \approx
4.90\)</span>. Thinking through this, these offsets are the logs of the
arithmetic and geometric means, respectively, of <code>Holders</code>;
and it is the fact that the offset is logged that makes those EMMs
differ.</p>
<p>With Poisson models, we often want to estimate rates rather than
counts; and we can do that by specifying an offset of <span class="math inline">\(\log 1 = 0\)</span> to get a rate per holder:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">rg1</span>, <span class="st">"Age"</span>, offset <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Age    rate      SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  &lt;25   0.230 0.01580 Inf     0.201     0.264</span></span>
<span><span class="co">##  25-29 0.190 0.00993 Inf     0.172     0.211</span></span>
<span><span class="co">##  30-35 0.163 0.00805 Inf     0.148     0.180</span></span>
<span><span class="co">##  &gt;35   0.135 0.00355 Inf     0.128     0.142</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: District, Group </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## Intervals are back-transformed from the log scale</span></span></code></pre>
<p>We’d get exactly the same estimates using <code>rg2</code> because in
both cases, we are forcing the offset to be zero.</p>
<p>Finally, suppose we want to use different offsets for each age group.
This is done as follows: For <code>mod1</code>, we compute
<code>mean(Holders)</code> separately for each <code>Age</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mod1</span>, <span class="st">"Age"</span>, cov.reduce <span class="op">=</span> <span class="va">Holders</span> <span class="op">~</span> <span class="va">Age</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Age   emmean     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  &lt;25     2.80 0.0686 Inf      2.66      2.93</span></span>
<span><span class="co">##  25-29   3.32 0.0522 Inf      3.22      3.43</span></span>
<span><span class="co">##  30-35   3.42 0.0493 Inf      3.33      3.52</span></span>
<span><span class="co">##  &gt;35     4.96 0.0264 Inf      4.91      5.01</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: District, Group </span></span>
<span><span class="co">## Results are given on the log (not the response) scale. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>For <code>mod2</code>, <code>Holders</code> is not considered a
predictor, and instead we need separate mean offsets:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mod2</span>, <span class="st">"Age"</span>, cov.reduce <span class="op">=</span> <span class="va">.static.offset.</span> <span class="op">~</span> <span class="va">Age</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Age   emmean     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  &lt;25     2.15 0.0686 Inf      2.02      2.29</span></span>
<span><span class="co">##  25-29   2.90 0.0522 Inf      2.79      3.00</span></span>
<span><span class="co">##  30-35   3.04 0.0493 Inf      2.95      3.14</span></span>
<span><span class="co">##  &gt;35     4.58 0.0264 Inf      4.53      4.63</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: District, Group </span></span>
<span><span class="co">## Results are given on the log (not the response) scale. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>In both models, the EMMs increase rather than decrease with age,
reflecting larger numbers of holders as age increases.</p>
<p><a href="#contents">Back to Contents</a></p>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell V. Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
