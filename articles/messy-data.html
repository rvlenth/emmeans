<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="emmeans">
<title>Working with messy data • emmeans</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with messy data">
<meta property="og:description" content="emmeans">
<meta property="og:image" content="https://rvlenth.github.io/emmeans/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">emmeans</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/AQuickStart.html">Quick start guide for **emmeans**</a>
    <a class="dropdown-item" href="../articles/basics.html">Basics of estimated marginal means</a>
    <a class="dropdown-item" href="../articles/comparisons.html">Comparisons and contrasts in emmeans</a>
    <a class="dropdown-item" href="../articles/confidence-intervals.html">Confidence intervals and tests in emmeans</a>
    <a class="dropdown-item" href="../articles/FAQs.html">FAQs for emmeans</a>
    <a class="dropdown-item" href="../articles/interactions.html">Interaction analysis in emmeans</a>
    <a class="dropdown-item" href="../articles/messy-data.html">Working with messy data</a>
    <a class="dropdown-item" href="../articles/models.html">Models supported by emmeans</a>
    <a class="dropdown-item" href="../articles/predictions.html">Prediction in **emmeans**</a>
    <a class="dropdown-item" href="../articles/re-engineering-clds.html">Re-engineering CLDs</a>
    <a class="dropdown-item" href="../articles/sophisticated.html">Sophisticated models in emmeans</a>
    <a class="dropdown-item" href="../articles/transformations.html">Transformations and link functions in emmeans</a>
    <a class="dropdown-item" href="../articles/utilities.html">Utilities and options for emmeans</a>
    <a class="dropdown-item" href="../articles/vignette-topics.html">Index of vignette topics</a>
    <a class="dropdown-item" href="../articles/xplanations.html">Explanations supplement</a>
    <a class="dropdown-item" href="../articles/xtending.html">For developers: Extending **emmeans**</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rvlenth/emmeans/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Working with messy data</h1>
                        <h4 data-toc-skip class="author">emmeans
package, Version 1.10.2</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/emmeans/blob/HEAD/vignettes/messy-data.Rmd" class="external-link"><code>vignettes/messy-data.Rmd</code></a></small>
      <div class="d-none name"><code>messy-data.Rmd</code></div>
    </div>

    
    
<!-- @index Vignettes!Messy data -->
<div class="section level2">
<h2 id="contents">Contents<a class="anchor" aria-label="anchor" href="#contents"></a>
</h2>
<ol style="list-style-type: decimal">
<li><a href="#issues">Issues with observational data</a></li>
<li><a href="#mediators">Mediating covariates</a></li>
<li><a href="#weights">Mediating factors and weights</a></li>
<li><a href="#nuisance">Nuisance factors</a></li>
<li><a href="#counterfact">Counterfactuals and G-Computation</a></li>
<li><a href="#submodels">Sub-models</a></li>
<li>
<a href="#nesting">Nested fixed effects</a>
<ol style="list-style-type: lower-alpha">
<li><a href="#nest-trap">Avoiding mis-identified nesting</a></li>
</ol>
</li>
</ol>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
<div class="section level2">
<h2 id="issues">Issues with observational data<a class="anchor" aria-label="anchor" href="#issues"></a>
</h2>
<!-- @index Observational data -->
<p>In experiments, we control the conditions under which observations
are made. Ideally, this leads to balanced datasets and clear inferences
about the effects of those experimental conditions. In observational
data, factor levels are observed rather than controlled, and in the
analysis we control <em>for</em> those factors and covariates. It is
possible that some factors and covariates lie in the causal path for
other predictors. Observational studies can be designed in ways to
mitigate some of these issues; but often we are left with a mess. Using
EMMs does not solve the inherent problems in messy, undesigned studies;
but they do give us ways to compensate for imbalance in the data, and
allow us to estimate meaningful effects after carefully considering the
ways in which they can be confounded.</p>
<div id="nutrex" class="section level7">
<p class="heading"></p>
<!-- @index Examples!`nutrition` -->
<p>As an illustration, consider the <code>nutrition</code> dataset
provided with the package. These data are used as an example in Milliken
and Johnson (1992), <em>Analysis of Messy Data</em>, and contain the
results of an observational study on nutrition education. Low-income
mothers are classified by race, age category, and whether or not they
received food stamps (the <code>group</code> factor); and the response
variable is a gain score (post minus pre scores) after completing a
nutrition training program. First, let’s fit a model than includes all
main effects and 2-way interactions, and obtain its “type II” ANOVA:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nutr.lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">gain</span> <span class="op">~</span> <span class="op">(</span><span class="va">age</span> <span class="op">+</span> <span class="va">group</span> <span class="op">+</span> <span class="va">race</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, data <span class="op">=</span> <span class="va">nutrition</span><span class="op">)</span> </span>
<span><span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html" class="external-link">Anova</a></span><span class="op">(</span><span class="va">nutr.lm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Note: model has aliased coefficients</span></span>
<span><span class="co">##       sums of squares computed by model comparison</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## Anova Table (Type II tests)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Response: gain</span></span>
<span><span class="co">##             Sum Sq Df F value    Pr(&gt;F)</span></span>
<span><span class="co">## age          82.37  3  0.9614    0.4145</span></span>
<span><span class="co">## group       658.13  1 23.0441 6.105e-06</span></span>
<span><span class="co">## race         11.17  2  0.1956    0.8227</span></span>
<span><span class="co">## age:group    91.58  3  1.0688    0.3663</span></span>
<span><span class="co">## age:race     87.30  3  1.0189    0.3880</span></span>
<span><span class="co">## group:race  113.70  2  1.9906    0.1424</span></span>
<span><span class="co">## Residuals  2627.47 92</span></span></code></pre>
<p>There is definitely a <code>group</code> effect and a hint of and
interaction with <code>race</code>. Here are the EMMs for those two
factors, along with their counts:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">nutr.lm</span>, <span class="op">~</span> <span class="va">group</span> <span class="op">*</span> <span class="va">race</span>, calc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>n <span class="op">=</span> <span class="st">".wgt."</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  group      race     emmean   SE df  n lower.CL upper.CL</span></span>
<span><span class="co">##  FoodStamps Black      4.71 2.37 92  7  0.00497     9.41</span></span>
<span><span class="co">##  NoAid      Black     -2.19 2.49 92 14 -7.13690     2.76</span></span>
<span><span class="co">##  FoodStamps Hispanic nonEst   NA NA  1       NA       NA</span></span>
<span><span class="co">##  NoAid      Hispanic nonEst   NA NA  2       NA       NA</span></span>
<span><span class="co">##  FoodStamps White      3.61 1.16 92 52  1.31252     5.90</span></span>
<span><span class="co">##  NoAid      White      2.26 2.39 92 31 -2.48897     7.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
</div>
<div id="nonestex" class="section level7">
<p class="heading"></p>
<!-- @index Non-estimability; Estimability -->
<p>Hmmmm. The EMMs when <code>race</code> is “Hispanic” are not given;
instead they are flagged as non-estimable. What does that mean? Well,
when using a model to make predictions, it is impossible to do that
beyond the linear space of the data used to fit the model. And we have
no data for three of the age groups in the Hispanic population:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">nutrition</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">race</span>, <span class="va">age</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##           age</span></span>
<span><span class="co">## race        1  2  3  4</span></span>
<span><span class="co">##   Black     2  7 10  2</span></span>
<span><span class="co">##   Hispanic  0  0  3  0</span></span>
<span><span class="co">##   White     5 16 51 11</span></span></code></pre>
<p>We can’t make predictions for all the cases we are averaging over in
the above EMMs, and that is why some of them are non-estimable. The
bottom line is that we simply cannot include Hispanics in the mix when
comparing factor effects. That’s a limitation of this study that cannot
be overcome without collecting additional data. Our choices for further
analysis are to focus only on Black and White populations; or to focus
only on age group 3. For example (the latter):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">nutr.lm</span>, <span class="va">pairwise</span> <span class="op">~</span> <span class="va">group</span> <span class="op">|</span> <span class="va">race</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"3"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>by <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Note: adjust = "tukey" was changed to "sidak"</span></span>
<span><span class="co">## because "tukey" is only appropriate for one set of pairwise comparisons</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## $emmeans</span></span>
<span><span class="co">##  group      race     emmean   SE df lower.CL upper.CL</span></span>
<span><span class="co">##  FoodStamps Black      7.50 2.67 92     2.19   12.807</span></span>
<span><span class="co">##  NoAid      Black     -3.67 2.18 92    -8.00    0.666</span></span>
<span><span class="co">##  FoodStamps Hispanic   0.00 5.34 92   -10.61   10.614</span></span>
<span><span class="co">##  NoAid      Hispanic   2.50 3.78 92    -5.01   10.005</span></span>
<span><span class="co">##  FoodStamps White      5.42 0.96 92     3.51    7.326</span></span>
<span><span class="co">##  NoAid      White     -0.20 1.19 92    -2.57    2.173</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $contrasts</span></span>
<span><span class="co">##  contrast           race     estimate   SE df t.ratio p.value</span></span>
<span><span class="co">##  FoodStamps - NoAid Black       11.17 3.45 92   3.237  0.0050</span></span>
<span><span class="co">##  FoodStamps - NoAid Hispanic    -2.50 6.55 92  -0.382  0.9739</span></span>
<span><span class="co">##  FoodStamps - NoAid White        5.62 1.53 92   3.666  0.0012</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## P value adjustment: sidak method for 3 tests</span></span></code></pre>
<p>(We used trickery with providing a <code>by</code> variable, and then
taking it away, to make the output more compact.) Evidently, the
training program has been beneficial to the Black and White groups in
that age category. There is no conclusion for the Hispanic group – for
which we have very little data.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="mediators">Mediating covariates<a class="anchor" aria-label="anchor" href="#mediators"></a>
</h2>
<!-- @index Mediating covariates; Examples!`framing`; Covariates!Mediating -->
<p>The <code>framing</code> data in the <strong>mediation</strong>
package has the results of an experiment conducted by Brader et
al. (2008) where subjects were given the opportunity to send a message
to Congress regarding immigration. However, before being offered this,
some subjects (<code>treat = 1</code>) were first shown a news story
that portrays Latinos in a negative way. Besides the binary response
(whether or not they elected to send a message), the experimenters also
measured <code>emo</code>, the subjects’ emotional state after the
treatment was applied. There are various demographic variables as well.
Let’s a logistic regression model, after changing the labels for
<code>educ</code> to shorter strings.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">framing</span> <span class="op">&lt;-</span> <span class="fu">mediation</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/mediation/man/framing.html" class="external-link">framing</a></span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">framing</span><span class="op">$</span><span class="va">educ</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NA"</span>,<span class="st">"Ref"</span>,<span class="st">"&lt; HS"</span>, <span class="st">"HS"</span>, <span class="st">"&gt; HS"</span>,<span class="st">"Coll +"</span><span class="op">)</span> </span>
<span><span class="va">framing.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">cong_mesg</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">emo</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span>, </span>
<span>    family <span class="op">=</span> <span class="va">binomial</span>, data <span class="op">=</span> <span class="va">framing</span><span class="op">)</span></span></code></pre></div>
<p>The conventional way to handle covariates like <code>emo</code> is to
set them at their means and use those means for purposes of predictions
and EMMs. These adjusted means are shown in the following plot.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmip.html">emmip</a></span><span class="op">(</span><span class="va">framing.glm</span>, <span class="va">treat</span> <span class="op">~</span> <span class="va">educ</span> <span class="op">|</span> <span class="va">gender</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="messy-data_files/figure-html/unnamed-chunk-7-1.png" alt="Two panels, each showing a decreasing trend with educ except they increase again with educ=Coll+. In the male panel, the curve for treat 1 is higher than that for treat 2, while the reverse is true in the female panel" width="432"></p>
<p>This plot gives the impression that the effect of <code>treat</code>
is reversed between male and female subjects; and also that the effect
of education is not monotone. Both of these are counter-intuitive.</p>
<div class="section level6">
<h6 id="med-covred"></h6>
<!-- @index `cov.reduce` -->
<p>However, note that the covariate <code>emo</code> is measured
<em>post</em>-treatment. That suggests that in fact <code>treat</code>
(and perhaps other factors) could affect the value of <code>emo</code>;
and if that is true (as is in fact established by mediation analysis
techniques), we should not pretend that <code>emo</code> can be set
independently of <code>treat</code> as was done to obtain the EMMs shown
above. Instead, let <code>emo</code> depend on <code>treat</code> and
the other predictors – easily done using <code>cov.reduce</code> – and
we obtain an entirely different impression:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmip.html">emmip</a></span><span class="op">(</span><span class="va">framing.glm</span>, <span class="va">treat</span> <span class="op">~</span> <span class="va">educ</span> <span class="op">|</span> <span class="va">gender</span>, type <span class="op">=</span> <span class="st">"response"</span>, </span>
<span>    cov.reduce <span class="op">=</span> <span class="va">emo</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">income</span><span class="op">)</span></span></code></pre></div>
<p><img src="messy-data_files/figure-html/unnamed-chunk-8-1.png" alt="Similar to previous figure but now the curves flatten out with &gt;HS about the same as Coll+. For the maile panel, we still have the trace for treat 1 higher than for treat 0; but in the female panel, they are about the same as each other, and a bit lower than treat 0 for males. To see these results in numerical form, call emmeans() with the same arguments *except* replace the second argument with ~treat*educ|gender" width="432"></p>
<p>The reference grid underlying this plot has different
<code>emo</code> values for each factor combination. The plot suggests
that, after taking emotional response into account, male (but not
female) subjects exposed to the negative news story are more likely to
send the message than are females or those not seeing the negative news
story. Also, the effect of <code>educ</code> is now nearly monotone.</p>
</div>
<div class="section level6">
<h6 id="adjcov"></h6>
<!-- @index Covariates!Adjusted -->
<p>By the way, the results in this plot are the same is what you would
obtain by refitting the model with an adjusted covariate</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emo.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">emo</span> <span class="op">~</span> <span class="va">treat</span><span class="op">*</span><span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">income</span>, data <span class="op">=</span> <span class="va">framing</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>… and then using ordinary covariate-adjusted means at the means of
<code>emo.adj</code>. This is a technique that is often recommended.</p>
<p>If there is more than one mediating covariate, their settings may be
defined in sequence; for example, if <code>x1</code>, <code>x2</code>,
and <code>x3</code> are all mediating covariates, we might use</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">...</span>, cov.reduce <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x1</span> <span class="op">~</span> <span class="va">trt</span>, <span class="va">x2</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">x1</span>, <span class="va">x3</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>(or possibly with some interactions included as well).</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="weights">Mediating factors and weights<a class="anchor" aria-label="anchor" href="#weights"></a>
</h2>
<!-- @index Factors!Mediating; `weights`; `emmeans()`!`weights`
            Examples!`nutrition`!`weights` -->
<p>A mediating covariate is one that is in the causal path; likewise, it
is possible to have a mediating <em>factor</em>. For mediating factors,
the moral equivalent of the <code>cov.reduce</code> technique described
above is to use <em>weighted</em> averages in lieu of equally-weighted
ones in computing EMMs. The weights used in these averages should depend
on the frequencies of mediating factor(s). Usually, the
<code>"cells"</code> weighting scheme described later in this section is
the right approach. In complex situations, it may be necessary to
compute EMMs in stages.</p>
<p>As described in <a href="basics.html#emmeans">the “basics”
vignette</a>, EMMs are usually defined as <em>equally-weighted</em>
means of reference-grid predictions. However, there are several built-in
alternative weighting schemes that are available by specifying a
character value for <code>weights</code> in a call to
<code><a href="../reference/emmeans.html">emmeans()</a></code> or related function. The options are
<code>"equal"</code> (the default), <code>"proportional"</code>,
<code>"outer"</code>, <code>"cells"</code>, and <code>"flat"</code>.</p>
<p>The <code>"proportional"</code> (or <code>"prop"</code> for short)
method weights proportionally to the frequencies (or model weights) of
each factor combination that is averaged over. The <code>"outer"</code>
method uses the outer product of the marginal frequencies of each factor
that is being averaged over. To explain the distinction, suppose the
EMMs for <code>A</code> involve averaging over two factors
<code>B</code> and <code>C</code>. With <code>"prop"</code>, we use the
frequencies for each combination of <code>B</code> and <code>C</code>;
whereas for <code>"outer"</code>, first obtain the marginal frequencies
for <code>B</code> and for <code>C</code> and weight proportionally to
the product of these for each combination of <code>B</code> and
<code>C</code>. The latter weights are like the “expected” counts used
in a chi-square test for independence. Put another way, outer weighting
is the same as proportional weighting applied one factor at a time; the
following two would yield the same results:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"A"</span>, weights <span class="op">=</span> <span class="st">"outer"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, weights <span class="op">=</span> <span class="st">"prop"</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span>weights <span class="op">=</span> <span class="st">"prop"</span><span class="op">)</span> </span></code></pre></div>
<p>Using <code>"cells"</code> weights gives each prediction the same
weight as occurs in the model; applied to a reference grid for a model
with all interactions, <code>"cells"</code>-weighted EMMs are the same
as the ordinary marginal means of the data. With <code>"flat"</code>
weights, equal weights are used, except zero weight is applied to any
factor combination having no data. Usually, <code>"cells"</code> or
<code>"flat"</code> weighting will <em>not</em> produce non-estimable
results, because we exclude empty cells. (That said, if covariates are
linearly dependent with factors, we may still encounter non-estimable
cases.)</p>
<p>Here is a comparison of predictions for <code>nutr.lm</code> defined
<a href="#issues">above</a>, using different weighting schemes:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"equal"</span>, <span class="st">"prop"</span>, <span class="st">"outer"</span>, <span class="st">"cells"</span>, <span class="st">"flat"</span><span class="op">)</span>, \<span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">nutr.lm</span>, <span class="op">~</span> <span class="va">race</span>, weights <span class="op">=</span> <span class="va">w</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##         equal     prop    outer     cells      flat</span></span>
<span><span class="co">## [1,] 1.258929 1.926554 2.546674 0.3809524 0.6865079</span></span>
<span><span class="co">## [2,]       NA       NA       NA 1.6666667 1.2500000</span></span>
<span><span class="co">## [3,] 2.932008 2.522821 3.142940 2.7951807 1.6103407</span></span></code></pre>
<p>In the other hand, if we do <code>group * race</code> EMMs, only one
factor (<code>age</code>) is averaged over; thus, the results for
<code>"prop"</code> and <code>"outer"</code> weights will be identical
in that case.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div class="section level2">
<h2 id="nuisance">Nuisance factors<a class="anchor" aria-label="anchor" href="#nuisance"></a>
</h2>
<!-- @index Nuisance factors; `nuisance`; `non.nuisance`; `wt.nuis`;
     Memory usage; Large models; Models!Large -->
<p>Consider a situation where we have a model with 15 factors, each at 5
levels. Regardless of how simple or complex the model is, the reference
grid consists of all combinations of these factors – and there are <span class="math inline">\(5^{15}\)</span> of these, or over 30 billion. If
there are, say, 100 regression coefficients in the model, then just the
<code>linfct</code> slot in the reference grid requires <span class="math inline">\(100\times5^{15}\times8\)</span> bytes of storage,
or almost 23,000 gigabytes. Suppose in addition the model has a
multivariate response with 5 levels. That multiplies <em>both</em> the
rows and columns in <code>linfct</code>, increasing the storage
requirements by a factor of 25. Either way, your computer can’t store
that much – so this definitely qualifies as a messy situation!</p>
<p>The <code><a href="../reference/ref_grid.html">ref_grid()</a></code> function now provides some relief, in the
way of specifying some of the factors as “nuisance” factors. The
reference grid is then constructed with those factors already
averaged-out. So, for example with the same scenario, if only three of
those 15 factors are of primary interest, and we specify the other 12 as
nuisance factors to be averaged, that leaves us with only <span class="math inline">\(3^5=125\)</span> rows in the reference grid, and
hence <span class="math inline">\(125\times100\times8=10,000\)</span>
bytes of storage required for <code>linfct</code>. If there is a 5-level
multivariate response, we’ll have 625 rows in the reference grid and
<span class="math inline">\(25\times1000=250,000\)</span> bytes in
<code>linfct</code>. Suddenly a horribly unmanageable situation becomes
quite manageable!</p>
<p>But of course, there is a restriction: nuisance factors must not
interact with any other factors – not even other nuisance factors. And a
multivariate response (or an implied multivariate response, e.g., in an
ordinal model) can never be a nuisance factor. Under that condition, the
average effects of a nuisance factor are the same regardless of the
levels of other factors, making it possible to pre-average them by
considering just one case.</p>
<p>We specify nuisance factors by listing their names in a
<code>nuisance</code> argument to <code><a href="../reference/ref_grid.html">ref_grid()</a></code> (in
<code><a href="../reference/emmeans.html">emmeans()</a></code>, this argument is passed to
<code>ref_grid)</code>). Often, it is much more convenient to give the
factors that are <em>not</em> nuisance factors, via a
<code>non.nuisance</code> argument. If you do specify a nuisance factor
that does interact with others, or doesn’t exist, it is quietly excluded
from the nuisance list.</p>
<div class="section level6">
<h6 id="nuis-example"></h6>
<!-- @index Examples!`mtcars` -->
<p>Time for an example. Consider the <code>mtcars</code> dataset
standard in R, and the model</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars.lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span><span class="op">*</span><span class="va">am</span> <span class="op">+</span> <span class="va">disp</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">drat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">wt</span><span class="op">)</span> <span class="op">+</span> <span class="va">vs</span> <span class="op">+</span> </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">carb</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<p>And let’s construct two different reference grids:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rg.usual</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">mtcars.lm</span><span class="op">)</span></span>
<span><span class="va">rg.usual</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     cyl = 4, 6, 8</span></span>
<span><span class="co">##     am = 0, 1</span></span>
<span><span class="co">##     disp = 230.72</span></span>
<span><span class="co">##     hp = 146.69</span></span>
<span><span class="co">##     drat = 3.5966</span></span>
<span><span class="co">##     wt = 3.2172</span></span>
<span><span class="co">##     vs = 0, 1</span></span>
<span><span class="co">##     gear = 3, 4, 5</span></span>
<span><span class="co">##     carb = 1, 2, 3, 4, 6, 8</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rg.usual</span><span class="op">@</span><span class="va">linfct</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## [1] 216</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rg.nuis</span> <span class="op">=</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">mtcars.lm</span>, non.nuisance <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NOTE: A nesting structure was detected in the fitted model:</span></span>
<span><span class="co">##     cyl %in% am</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rg.nuis</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     cyl = 4, 6, 8</span></span>
<span><span class="co">##     am = 0, 1</span></span>
<span><span class="co">##     disp = (predicted by other variables)</span></span>
<span><span class="co">##     hp = (predicted by other variables)</span></span>
<span><span class="co">##     drat = (predicted by other variables)</span></span>
<span><span class="co">##     wt = (predicted by other variables)</span></span>
<span><span class="co">##     vs = (predicted by other variables)</span></span>
<span><span class="co">##     gear = (predicted by other variables)</span></span>
<span><span class="co">##     carb = (predicted by other variables)</span></span>
<span><span class="co">## Nuisance factors that have been collapsed by averaging:</span></span>
<span><span class="co">##     disp(1), hp(1), drat(1), wt(1), vs(2), gear(3), carb(6)</span></span>
<span><span class="co">## Nesting structure:  cyl %in% am</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rg.nuis</span><span class="op">@</span><span class="va">linfct</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## [1] 6</span></span></code></pre>
<p>Notice that we left <code>am</code> out of <code>non.nuisance</code>
and hence included it in <code>nuisance</code>. However, it interacts
with <code>cyl</code>, so it was not allowed as a nuisance factor. But
<code>rg.nuis</code> requires 1/36 as much storage. There’s really
nothing else to show, other than to demonstrate that we get the same
EMMs either way, with slightly different annotations:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">rg.usual</span>, <span class="op">~</span> <span class="va">cyl</span> <span class="op">*</span> <span class="va">am</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  cyl am emmean   SE df lower.CL upper.CL</span></span>
<span><span class="co">##    4  0   19.0 4.29 14    9.823     28.2</span></span>
<span><span class="co">##    6  0   19.7 3.32 14   12.556     26.8</span></span>
<span><span class="co">##    8  0   29.0 5.98 14   16.130     41.8</span></span>
<span><span class="co">##    4  1   15.4 4.29 14    6.206     24.6</span></span>
<span><span class="co">##    6  1   27.3 4.90 14   16.741     37.8</span></span>
<span><span class="co">##    8  1   11.2 5.56 14   -0.718     23.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: vs, gear, carb </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">rg.nuis</span>, <span class="op">~</span> <span class="va">cyl</span> <span class="op">*</span> <span class="va">am</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  cyl am emmean   SE df lower.CL upper.CL</span></span>
<span><span class="co">##    4  0   19.0 4.29 14     9.82     28.2</span></span>
<span><span class="co">##    6  0   19.7 3.32 14    12.56     26.8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: 7 nuisance factors </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>By default, the pre-averaging is done with equal weights. If we
specify <code>wt.nuis</code> as anything other than
<code>"equal"</code>, they are averaged proportionally. As described
above, this really amounts to <code>"outer"</code> weights since they
are averaged separately. Let’s try it to see how the estimates
differ:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mtcars.lm</span>, <span class="op">~</span> <span class="va">cyl</span> <span class="op">*</span> <span class="va">am</span>, non.nuis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"am"</span><span class="op">)</span>, </span>
<span>                wt.nuis <span class="op">=</span> <span class="st">"prop"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NOTE: A nesting structure was detected in the fitted model:</span></span>
<span><span class="co">##     cyl %in% am</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## [1] 16.51254 17.17869</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mtcars.lm</span>, <span class="op">~</span> <span class="va">cyl</span> <span class="op">*</span> <span class="va">am</span>, weights <span class="op">=</span> <span class="st">"outer"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## [1] 16.51254 17.17869 26.45709 12.90600 24.75053  8.70546</span></span></code></pre>
<p>These are the same as each other, but different from the
equally-weighted EMMs we obtained before. By the way, to help make
things consistent, if <code>weights</code> is character,
<code><a href="../reference/emmeans.html">emmeans()</a></code> passes <code>wt.nuis = weights</code> to
<code>ref_grid</code> (if it is called), unless <code>wt.nuis</code> is
also specified.</p>
<p>There is a trick to get <code>emmeans</code> to use the smallest
possible reference grid: Pass the <code>specs</code> argument to
<code><a href="../reference/ref_grid.html">ref_grid()</a></code> as <code>non.nuisance</code>. But we have to
quote it to delay evaluation, and also use <code><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars()</a></code> if
(and only if) <code>specs</code> is a formula:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">mtcars.lm</span>, <span class="op">~</span> <span class="va">gear</span> <span class="op">|</span> <span class="va">am</span>, non.nuis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NOTE: A nesting structure was detected in the fitted model:</span></span>
<span><span class="co">##     am %in% gear</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## gear = 3, am = 0:</span></span>
<span><span class="co">##  emmean   SE df lower.CL upper.CL</span></span>
<span><span class="co">##    15.2 2.65 14     9.56     20.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## gear = 4, am = 1:</span></span>
<span><span class="co">##  emmean   SE df lower.CL upper.CL</span></span>
<span><span class="co">##    17.8 2.62 14    12.19     23.4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: 6 nuisance factors, cyl </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Observe that <code>cyl</code> was passed over as a nuisance factor
because it interacts with another factor.</p>
</div>
<div class="section level3">
<h3 id="rg-limit">Limiting the size of the reference grid<a class="anchor" aria-label="anchor" href="#rg-limit"></a>
</h3>
<!-- @index  `rg.limit` option; Memory usage!Limiting -->
<p>We have just seen how easily the size of a reference grid can get out
of hand. The <code>rg.limit</code> option (set via
<code><a href="../reference/emm_options.html">emm_options()</a></code> or as an optional argument in
<code><a href="../reference/ref_grid.html">ref_grid()</a></code> or <code><a href="../reference/emmeans.html">emmeans()</a></code>) serves to guard
against excessive memory demands. It specifies the number of allowed
rows in the reference grid. But because of the way
<code><a href="../reference/ref_grid.html">ref_grid()</a></code> works, this check is made <em>before</em> any
multivariate-response levels are taken into account. If the limit is
exceeded, an error is thrown:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">mtcars.lm</span>, rg.limit <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: The rows of your requested reference grid would be 216, which exceeds</span></span>
<span><span class="co">## the limit of 200 (not including any multivariate responses).</span></span>
<span><span class="co">## Your options are:</span></span>
<span><span class="co">##   1. Specify some (or more) nuisance factors using the 'nuisance' argument</span></span>
<span><span class="co">##      (see ?ref_grid). These must be factors that do not interact with others.</span></span>
<span><span class="co">##   2. Add the argument 'rg.limit = &lt;new limit&gt;' to the call. Be careful,</span></span>
<span><span class="co">##      because this could cause excessive memory use and performance issues.</span></span>
<span><span class="co">##      Or, change the default via 'emm_options(rg.limit = &lt;new limit&gt;)'.</span></span></code></pre>
<p>The default <code>rg.limit</code> is 10,000. With this limit, and if
we have 1,000 columns in the model matrix, then the size of
<code>linfct</code> is limited to about 80MB. If in addition, there is a
5-level multivariate response, the limit is 2GB – darn big, but perhaps
manageable. Even so, I suspect that the 10000-row default may be to
loose to guard against some users getting into a tight situation.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="counterfact">Counterfactuals and G-Computation<a class="anchor" aria-label="anchor" href="#counterfact"></a>
</h2>
<!-- @index Counterfactuals; Causal inference; G-Computation; -->
<p>G-computation is a method for model-based causal inference originated
by JM Robins (<em>Mathematical Modelling</em>, 1986), and we want to
remove confounding of treatment effects due to time-varying covariates
and such. The idea is that, under certain assumptions, we can use the
model to predict <em>every</em> subject’s response to each treatment –
not just the treatment they received. To do this, we make several copies
of the whole dataset, substituting the actual treatment(s) with each of
the possible treatment levels; these provide us with
<em>counterfactual</em> predictions. We then average those predictions
over each copy of the dataset. Typically, this averaging is done on the
response scale; that is the interesting case because on the link scale,
everything is linear and we can obtain basically the same results using
ordinary <code><a href="../reference/emmeans.html">emmeans()</a></code> computations with proportional
weights.</p>
<p>An additional consideration is that when we average each of the
counterfactual datasets, we are trying to represent the entire covariate
distribution, rather than conditioning on the cases in the dataset. So
it is a good idea to broaden the covariance estimate using, say, a
sandwich estimate.</p>
<p>This kind of computation has just a little bit in common with
nuisance variables, in that the net result is that we can sweep several
predictors out of the reference grid just by averaging them away. For
this to make sense, the predictors averaged-away will have been observed
<em>before</em> treatment so that their effects are separate from the
treatment effects.</p>
<p>The implementation of this in <strong>emmeans</strong> is via the
<code>counterfactuals</code> argument in <code><a href="../reference/ref_grid.html">ref_grid()</a></code> (but
usually passed from <code><a href="../reference/emmeans.html">emmeans()</a></code>). We simply specify the
factor(s) we want to keep. This creates an index variable
<code>.obs.no.</code> to keep track of the observations in the dataset,
and then the reference grid (before averaging) consists of every
observation of the dataset in combination with the
<code>counterfactuals</code> combinations.</p>
<div class="section level5">
<h5 id="neuralgia"></h5>
<!-- @index `vcov.`; Sandwich estimators;
    Examples!`neuralgia`!`counterfactuals` -->
<p>As an example, consider the <code>neuralgia</code> data, where we
have a binary response, pain, a treatment of interest (two active
treatments and placebo), and pre-treatment predictors of sex, age, and
duration of the condition. We will include the <code>vcovHC()</code>
covariance estimate in the <strong>sandwich</strong> package.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neuralgia.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Pain</span> <span class="op">~</span> <span class="va">Sex</span> <span class="op">+</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Duration</span> <span class="op">+</span> <span class="va">Treatment</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">neuralgia</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">neuralgia.glm</span>, <span class="st">"Treatment"</span>, counterfactuals <span class="op">=</span> <span class="st">"Treatment"</span>,</span>
<span>        vcov. <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">vcovHC</a></span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Treatment  prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  A         0.283 0.0792 Inf    0.1280     0.439</span></span>
<span><span class="co">##  B         0.221 0.0669 Inf    0.0894     0.352</span></span>
<span><span class="co">##  P         0.754 0.1041 Inf    0.5500     0.958</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: .obs.no. </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Note that the results are already on the response (probability)
scale, which is the default. Let’s compare this with what we get without
using counterfactuals (i.e., predicting at each covariate average):</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">neuralgia.glm</span>, <span class="st">"Treatment"</span>, weights <span class="op">=</span> <span class="st">"prop"</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  Treatment  prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##  A         0.196 0.1055 Inf    0.0617     0.475</span></span>
<span><span class="co">##  B         0.126 0.0822 Inf    0.0323     0.384</span></span>
<span><span class="co">##  P         0.855 0.0852 Inf    0.6053     0.958</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: Sex </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## Intervals are back-transformed from the logit scale</span></span></code></pre>
<p>These results are markedly different; the counterfactual method
produces smaller differences between each of the active treatments and
placebo.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="submodels">Sub-models<a class="anchor" aria-label="anchor" href="#submodels"></a>
</h2>
<!-- @index `submodel`; Models!Constrained 
             Examples!`nutrition`!`submodel` -->
<p>We have just seen that we can assign different weights to the levels
of containing factors. Another option is to constrain the effects of
those containing factors to zero. In essence, that means fitting a
different model without those containing effects; however, for certain
models (not all), an <code>emmGrid</code> may be updated with a
<code>submodel</code> specification so as to impose such a constraint.
For illustration, return again to the nutrition example, and consider
the analysis of <code>group</code> and <code>race</code> as before,
after removing interactions involving <code>age</code>:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">nutr.lm</span>, <span class="va">pairwise</span> <span class="op">~</span> <span class="va">group</span> <span class="op">|</span> <span class="va">race</span>, submodel <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">group</span><span class="op">*</span><span class="va">race</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>by <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Note: adjust = "tukey" was changed to "sidak"</span></span>
<span><span class="co">## because "tukey" is only appropriate for one set of pairwise comparisons</span></span></code></pre>
<pre class="ro"><code><span><span class="co">## $emmeans</span></span>
<span><span class="co">##  group      race     emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  FoodStamps Black      4.91 2.061 92    0.817    9.003</span></span>
<span><span class="co">##  NoAid      Black     -3.01 1.581 92   -6.148    0.133</span></span>
<span><span class="co">##  FoodStamps Hispanic  -1.18 5.413 92  -11.935    9.567</span></span>
<span><span class="co">##  NoAid      Hispanic   1.32 3.876 92   -6.382    9.014</span></span>
<span><span class="co">##  FoodStamps White      4.10 0.901 92    2.308    5.886</span></span>
<span><span class="co">##  NoAid      White     -1.44 1.114 92   -3.654    0.771</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## submodel: ~ age + group + race + group:race </span></span>
<span><span class="co">## Confidence level used: 0.95 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $contrasts</span></span>
<span><span class="co">##  contrast           race     estimate   SE df t.ratio p.value</span></span>
<span><span class="co">##  FoodStamps - NoAid Black        7.92 2.62 92   3.021  0.0098</span></span>
<span><span class="co">##  FoodStamps - NoAid Hispanic    -2.50 6.55 92  -0.382  0.9739</span></span>
<span><span class="co">##  FoodStamps - NoAid White        5.54 1.27 92   4.364  0.0001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## P value adjustment: sidak method for 3 tests</span></span></code></pre>
<p>If you like, you may confirm that we would obtain exactly the same
estimates if we had fitted that sub-model to the data, except we
continue to use the residual variance from the full model in tests and
confidence intervals. Without the interactions with <code>age</code>,
all of the marginal means become estimable. The results are somewhat
different from those obtained earlier where we narrowed the scope to
just age 3. These new estimates include all ages, averaging over them
equally, but with constraints that the interaction effects involving
<code>age</code> are all zero.</p>
<div class="section level6">
<h6 id="type2submodel"></h6>
<!-- @index `submodel`!`"minimal"` and `"type2"`; Type II analysis
     `joint_tests()`!with `submodel = "type2"`  -->
<p>There are two special character values that may be used with
<code>submodel</code>. Specifying <code>"minimal"</code> creates a
submodel with only the active factors:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">nutr.lm</span>, <span class="op">~</span> <span class="va">group</span> <span class="op">*</span> <span class="va">race</span>, submodel <span class="op">=</span> <span class="st">"minimal"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  group      race     emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  FoodStamps Black     5.000 2.020 92    0.988    9.012</span></span>
<span><span class="co">##  NoAid      Black    -1.929 1.428 92   -4.765    0.908</span></span>
<span><span class="co">##  FoodStamps Hispanic  0.000 5.344 92  -10.614   10.614</span></span>
<span><span class="co">##  NoAid      Hispanic  2.500 3.779 92   -5.005   10.005</span></span>
<span><span class="co">##  FoodStamps White     4.769 0.741 92    3.297    6.241</span></span>
<span><span class="co">##  NoAid      White    -0.516 0.960 92   -2.422    1.390</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: age </span></span>
<span><span class="co">## submodel: ~ group + race + group:race </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>This submodel constrains all effects involving <code>age</code> to be
zero. Another interesting option is <code>"type2"</code>, whereby we in
essence analyze the residuals of the model with all contained or
overlapping effects, then constrain the containing effects to be zero.
So what is left if only the interaction effects of the factors involved.
This is most useful with <code><a href="../reference/joint_tests.html">joint_tests()</a></code>:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/joint_tests.html">joint_tests</a></span><span class="op">(</span><span class="va">nutr.lm</span>, submodel <span class="op">=</span> <span class="st">"type2"</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  model term df1 df2 F.ratio p.value note</span></span>
<span><span class="co">##  age          3  92   0.961  0.4145     </span></span>
<span><span class="co">##  group        1  92  23.044  &lt;.0001     </span></span>
<span><span class="co">##  race         2  92   0.196  0.8227     </span></span>
<span><span class="co">##  age:group    3  92   1.069  0.3663     </span></span>
<span><span class="co">##  age:race     3  92   1.019  0.3880  d e</span></span>
<span><span class="co">##  group:race   2  92   1.991  0.1424     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## d: df1 reduced due to linear dependence </span></span>
<span><span class="co">## e: df1 reduced due to non-estimability</span></span></code></pre>
<p>These results are identical to the type II anova obtained <a href="#nutrex">at the beginning of this example</a>.</p>
<p>More details on how <code>submodel</code> works may be found in <a href="xplanations.html#submodels"><code>vignette("xplanations")</code></a></p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div class="section level2">
<h2 id="nesting">Nested fixed effects<a class="anchor" aria-label="anchor" href="#nesting"></a>
</h2>
<!-- @index Nesting -->
<p>A factor <code>A</code> is nested in another factor <code>B</code> if
the levels of <code>A</code> have a different meaning in one level of
<code>B</code> than in another. Often, nested factors are random
effects—for example, subjects in an experiment may be randomly assigned
to treatments, in which case subjects are nested in treatments—and if we
model them as random effects, these random nested effects are not among
the fixed effects and are not an issue to <code>emmeans</code>. But
sometimes we have fixed nested factors.</p>
<div class="section level6">
<h6 id="cows"></h6>
<!-- @index Examples!`cows`; Examples!Nested fixed effects -->
<p>Here is an example of a fictional study of five fictional treatments
for some disease in cows. Two of the treatments are administered by
injection, and the other three are administered orally. There are
varying numbers of observations for each drug. The data and model
follow:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span></span>
<span>    route <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"injection"</span>, <span class="st">"oral"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    drug <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Bovineumab"</span>, <span class="st">"Charloisazepam"</span>, </span>
<span>              <span class="st">"Angustatin"</span>, <span class="st">"Herefordmycin"</span>, <span class="st">"Mollycoddle"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,  <span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    resp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">34</span>, <span class="fl">35</span>, <span class="fl">34</span>,   <span class="fl">44</span>, <span class="fl">43</span>,      <span class="fl">36</span>, <span class="fl">33</span>, <span class="fl">36</span>, <span class="fl">32</span>,   <span class="fl">26</span>, <span class="fl">25</span>,   <span class="fl">25</span>, <span class="fl">24</span>, <span class="fl">24</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cows.lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">resp</span> <span class="op">~</span> <span class="va">route</span> <span class="op">+</span> <span class="va">drug</span>, data <span class="op">=</span> <span class="va">cows</span><span class="op">)</span></span></code></pre></div>
<p>The <code>ref_grid</code> function finds a nested structure in this
model:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cows.rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ref_grid.html">ref_grid</a></span><span class="op">(</span><span class="va">cows.lm</span><span class="op">)</span></span>
<span><span class="va">cows.rg</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     route = injection, oral</span></span>
<span><span class="co">##     drug = Angustatin, Bovineumab, Charloisazepam, Herefordmycin, Mollycoddle</span></span>
<span><span class="co">## Nesting structure:  drug %in% route</span></span>
<span><span class="co">## Some things are non-estimable (null space dim = 1)</span></span></code></pre>
<p>When there is nesting, <code>emmeans</code> computes averages
separately in each group</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">route.emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">cows.rg</span>, <span class="st">"route"</span><span class="op">)</span></span>
<span><span class="va">route.emm</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  route     emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  injection   38.9 0.591  9     37.6     40.3</span></span>
<span><span class="co">##  oral        28.0 0.449  9     27.0     29.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: drug </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>… and insists on carrying along any grouping factors that a factor is
nested in:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug.emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emmeans.html">emmeans</a></span><span class="op">(</span><span class="va">cows.rg</span>, <span class="st">"drug"</span><span class="op">)</span></span>
<span><span class="va">drug.emm</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  drug           route     emmean    SE df lower.CL upper.CL</span></span>
<span><span class="co">##  Bovineumab     injection   34.3 0.747  9     32.6     36.0</span></span>
<span><span class="co">##  Charloisazepam injection   43.5 0.915  9     41.4     45.6</span></span>
<span><span class="co">##  Angustatin     oral        34.2 0.647  9     32.8     35.7</span></span>
<span><span class="co">##  Herefordmycin  oral        25.5 0.915  9     23.4     27.6</span></span>
<span><span class="co">##  Mollycoddle    oral        24.3 0.747  9     22.6     26.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code></pre>
<p>Here are the associated pairwise comparisons:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">route.emm</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">##  contrast         estimate    SE df t.ratio p.value</span></span>
<span><span class="co">##  oral - injection    -10.9 0.742  9 -14.671  &lt;.0001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: drug</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">drug.emm</span>, by <span class="op">=</span> <span class="st">"route"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre class="ro"><code><span><span class="co">## route = injection:</span></span>
<span><span class="co">##  contrast                    estimate    SE df t.ratio p.value</span></span>
<span><span class="co">##  Charloisazepam - Bovineumab     9.17 1.182  9   7.757  &lt;.0001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## route = oral:</span></span>
<span><span class="co">##  contrast                    estimate    SE df t.ratio p.value</span></span>
<span><span class="co">##  Herefordmycin - Angustatin     -8.75 1.121  9  -7.805  0.0001</span></span>
<span><span class="co">##  Mollycoddle - Angustatin       -9.92 0.989  9 -10.030  &lt;.0001</span></span>
<span><span class="co">##  Mollycoddle - Herefordmycin    -1.17 1.182  9  -0.987  0.6026</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## P value adjustment: tukey method for comparing a family of 3 estimates</span></span></code></pre>
<p>In the latter result, the contrast itself becomes a nested factor in
the returned <code>emmGrid</code> object. That would not be the case if
there had been no <code>by</code> variable.</p>
</div>
<div class="section level4">
<h4 id="graphs-with-nesting">Graphs with nesting<a class="anchor" aria-label="anchor" href="#graphs-with-nesting"></a>
</h4>
<!-- @index `emmip()`!nested factors; `plot()`!nested factors; **ggplot2** package -->
<p>It can be very helpful to take advantage of special features of
<strong>ggplot2</strong> when graphing results with nested factors. For
example, the default plot for the <code>cows</code> example is not
ideal:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emmip.html">emmip</a></span><span class="op">(</span><span class="va">cows.rg</span>, <span class="op">~</span> <span class="va">drug</span> <span class="op">|</span> <span class="va">route</span><span class="op">)</span></span></code></pre></div>
<p><img src="messy-data_files/figure-html/unnamed-chunk-29-1.png" alt="A panel for each route. This interaction plot has a lot of empty space because all 5 drugs are represented in each panel, and the x axis labels all overlap" width="528"></p>
<p>We can instead remove <code>route</code> from the call and instead
handle it with <strong>ggplot2</strong> code to use separate <em>x</em>
scales:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emmip.html">emmip</a></span><span class="op">(</span><span class="va">cows.rg</span>, <span class="op">~</span> <span class="va">drug</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">route</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span></span></code></pre></div>
<p><img src="messy-data_files/figure-html/unnamed-chunk-30-1.png" alt="This plot shows the same means as the previous one, but each panel shows only the drugs that are nested in each route" width="528"></p>
<p>Similarly with <code><a href="../reference/plot.html">plot.emmGrid()</a></code>:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">drug.emm</span>, PIs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">route</span>, nrow <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="messy-data_files/figure-html/unnamed-chunk-31-1.png" alt="side-by-side CIs and PIs for drugs in each route. Again, with free_y scaling, each panel contains only the drugs involved" width="528"></p>
</div>
<div class="section level3">
<h3 id="nest-trap">Auto-identification of nested factors – avoid being trapped!<a class="anchor" aria-label="anchor" href="#nest-trap"></a>
</h3>
<!-- @index Nesting!Auto-detection; `ref_grid()`!`nesting` -->
<p><code><a href="../reference/ref_grid.html">ref_grid()</a></code> and <code><a href="../reference/emmeans.html">emmeans()</a></code> tries to discover
and accommodate nested structures in the fixed effects. It does this in
two ways: first, by identifying factors whose levels appear in
combination with only one level of another factor; and second, by
examining the <code>terms</code> attribute of the fixed effects. In the
latter approach, if an interaction <code>A:B</code> appears in the model
but <code>A</code> is not present as a main effect, then <code>A</code>
is deemed to be nested in <code>B</code>. Note that this can create a
trap: some users take shortcuts by omitting some fixed effects, knowing
that this won’t affect the fitted values. But such shortcuts <em>do</em>
affect the interpretation of model parameters, ANOVA tables, etc., and I
advise against ever taking such shortcuts. Here are some ways you may
notice mistakenly-identified nesting:</p>
<ul>
<li>A message is displayed when nesting is detected</li>
<li>A <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> listing of the <code>emmGrid</code> object
shows a nesting component</li>
<li>An <code><a href="../reference/emmeans.html">emmeans()</a></code> summary unexpectedly includes one or more
factors that you didn’t specify</li>
<li>EMMs obtained using <code>by</code> factors don’t seem to behave
right, or give the same results with different specifications</li>
</ul>
<p>To override the auto-detection of nested effects, use the
<code>nesting</code> argument in <code><a href="../reference/ref_grid.html">ref_grid()</a></code> or
<code><a href="../reference/emmeans.html">emmeans()</a></code>. Specifying <code>nesting = NULL</code> will
ignore all nesting. Incorrectly-discovered nesting can be overcome by
specifying something akin to
<code>nesting = "A %in% B, C %in% (A * B)"</code> or, equivalently,
<code>nesting = list(A = "B",  C = c("A", "B"))</code>.</p>
<p><a href="#contents">Back to Contents</a></p>
<p><a href="vignette-topics.html">Index of all vignette topics</a></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell V. Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
