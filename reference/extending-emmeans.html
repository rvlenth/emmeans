<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Support functions for model extensions — extending-emmeans • emmeans</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Support functions for model extensions — extending-emmeans"><meta name="description" content='This documents some functions and methods that may be useful to package
developers wishing to add support for emmeans for their model objects.A user
or package developer may add emmeans support for a model
class by writing recover_data and emm_basis methods
for that class. (Users in need for a quick way to obtain results for a model
that is not supported may be better served by the qdrg function.)
There are several other exported functions that may be useful. See the
"xtending" vignette for more details.'><meta property="og:description" content='This documents some functions and methods that may be useful to package
developers wishing to add support for emmeans for their model objects.A user
or package developer may add emmeans support for a model
class by writing recover_data and emm_basis methods
for that class. (Users in need for a quick way to obtain results for a model
that is not supported may be better served by the qdrg function.)
There are several other exported functions that may be useful. See the
"xtending" vignette for more details.'><meta property="og:image" content="https://rvlenth.github.io/emmeans/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">emmeans</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.7-100002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/AQuickStart.html">Quick start guide for **emmeans**</a></li>
    <li><a class="dropdown-item" href="../articles/basics.html">Basics of estimated marginal means</a></li>
    <li><a class="dropdown-item" href="../articles/comparisons.html">Comparisons and contrasts in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/confidence-intervals.html">Confidence intervals and tests in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs for emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/interactions.html">Interaction analysis in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/messy-data.html">Working with messy data</a></li>
    <li><a class="dropdown-item" href="../articles/models.html">Models supported by emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/predictions.html">Prediction in **emmeans**</a></li>
    <li><a class="dropdown-item" href="../articles/re-engineering-clds.html">Re-engineering CLDs</a></li>
    <li><a class="dropdown-item" href="../articles/sophisticated.html">Sophisticated models in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/transformations.html">Transformations and link functions in emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/utilities.html">Utilities and options for emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-topics.html">Index of vignette topics</a></li>
    <li><a class="dropdown-item" href="../articles/xplanations.html">Explanations supplement</a></li>
    <li><a class="dropdown-item" href="../articles/xtending.html">For developers: Extending **emmeans**</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rvlenth/emmeans/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Support functions for model extensions</h1>
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/emmeans/blob/master/R/interfacing.R" class="external-link"><code>R/interfacing.R</code></a>, <a href="https://github.com/rvlenth/emmeans/blob/master/R/zzz.R" class="external-link"><code>R/zzz.R</code></a>, <a href="https://github.com/rvlenth/emmeans/blob/master/R/helpers.R" class="external-link"><code>R/helpers.R</code></a>, and 4 more</small>
      <div class="d-none name"><code>extending-emmeans.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This documents some functions and methods that may be useful to package
developers wishing to add support for <span class="pkg">emmeans</span> for their model objects.A user
or package developer may add <span class="pkg">emmeans</span> support for a model
class by writing <code>recover_data</code> and <code>emm_basis</code> methods
for that class. (Users in need for a quick way to obtain results for a model
that is not supported may be better served by the <code><a href="qdrg.html">qdrg</a></code> function.)
There are several other exported functions that may be useful. See the
"xtending" vignette for more details.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">recover_data</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'call'</span></span>
<span><span class="fu">recover_data</span><span class="op">(</span><span class="va">object</span>, <span class="va">trms</span>, <span class="va">na.action</span>, data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  params <span class="op">=</span> <span class="st">"pi"</span>, <span class="va">frame</span>, <span class="va">pwts</span>, <span class="va">addl.vars</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">emm_basis</span><span class="op">(</span><span class="va">object</span>, <span class="va">trms</span>, <span class="va">xlev</span>, <span class="va">grid</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.recover_data</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.emm_basis</span><span class="op">(</span><span class="va">object</span>, <span class="va">trms</span>, <span class="va">xlev</span>, <span class="va">grid</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.emm_register</span><span class="op">(</span><span class="va">classes</span>, <span class="va">pkgname</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.std.link.labels</span><span class="op">(</span><span class="va">fam</span>, <span class="va">misc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.combine.terms</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.aovlist.dffun</span><span class="op">(</span><span class="va">k</span>, <span class="va">dfargs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.cmpMM</span><span class="op">(</span><span class="va">X</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, assign <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">qr</span>, <span class="st">"assign"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get.excl</span><span class="op">(</span><span class="va">levs</span>, <span class="va">exc</span>, <span class="va">inc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get.offset</span><span class="op">(</span><span class="va">terms</span>, <span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.my.vcov</span><span class="op">(</span><span class="va">object</span>, vcov. <span class="op">=</span> <span class="va">.statsvcov</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.all.vars</span><span class="op">(</span><span class="va">expr</span>, retain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"\\$"</span>, <span class="st">"\\[\\["</span>, <span class="st">"\\]\\]"</span>, <span class="st">"'"</span>, <span class="st">"\""</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.diag</span><span class="op">(</span><span class="va">x</span>, <span class="va">nrow</span>, <span class="va">ncol</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.num.key</span><span class="op">(</span><span class="va">levs</span>, <span class="va">key</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.emm_vignette</span><span class="op">(</span>css <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"css"</span>, <span class="st">"clean-simple.css"</span>, package <span class="op">=</span></span>
<span>  <span class="st">"emmeans"</span><span class="op">)</span>, highlight <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.hurdle.support</span><span class="op">(</span><span class="va">cmu</span>, <span class="va">cshape</span>, <span class="va">cp0</span>, <span class="va">cmean</span>, <span class="va">zmu</span>, <span class="va">zshape</span>, <span class="va">zp0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.zi.support</span><span class="op">(</span><span class="va">zmu</span>, <span class="va">zshape</span>, <span class="va">zp0</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>An object of the same class as is supported by a new method.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional parameters that may be supported by the method.</p></dd>


<dt id="arg-trms">trms<a class="anchor" aria-label="anchor" href="#arg-trms"></a></dt>
<dd><p>The <code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></code> component of <code>object</code> (typically with
the response deleted, e.g. via <code><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">delete.response</a></code>)</p></dd>


<dt id="arg-na-action">na.action<a class="anchor" aria-label="anchor" href="#arg-na-action"></a></dt>
<dd><p>Integer vector of indices of observations to ignore; or
<code>NULL</code> if none</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Data frame. Usually, this is <code>NULL</code>. However, if non-null,
this is used in place of the reconstructed dataset. It must have all of the
predictors used in the model, and any factor levels must match those used
in fitting the model.</p></dd>


<dt id="arg-params">params<a class="anchor" aria-label="anchor" href="#arg-params"></a></dt>
<dd><p>Character vector giving the names of any variables in the model
formula that are <em>not</em> predictors. For example, a spline model may involve
a local variable <code>knots</code> that is not a predictor, but its value is
needed to fit the model. Names of parameters not actually used are harmless,
and the default value <code>"pi"</code> (the only numeric constant in base R)
is provided in case the model involves it. An example involving splines
may be found at <a href="https://github.com/rvlenth/emmeans/issues/180" class="external-link">https://github.com/rvlenth/emmeans/issues/180</a>.</p></dd>


<dt id="arg-frame">frame<a class="anchor" aria-label="anchor" href="#arg-frame"></a></dt>
<dd><p>Optional <code>data.frame</code>. Many model objects contain the
model frame used when fitting the model. In cases where there are no
predictor transformations, this model frame has all the original predictor
values and so is usable for recovering the data. Thus, if <code>frame</code> is
non-missing and <code>data</code> is <code>NULL</code>, a check is made on <code>trms</code>
and if there are no function calls, we use <code>data = frame</code>. This
can be helpful because it provides a modicum of security against the
possibility that the original data used when fitting the model has been
altered or removed.</p></dd>


<dt id="arg-pwts">pwts<a class="anchor" aria-label="anchor" href="#arg-pwts"></a></dt>
<dd><p>Optional vector of prior weights. Typically, this may be obtained
from the fitted <code>model</code> via <code>weights(model)</code>. If this is provided,
it is used to set weights as long as it is non-<code>NULL</code> and the same length
as the number of rows of the data.</p></dd>


<dt id="arg-addl-vars">addl.vars<a class="anchor" aria-label="anchor" href="#arg-addl-vars"></a></dt>
<dd><p>Character value or vector specifying additional predictors
to include in the reference grid. These must be names of variables that
exist, or you will get an error.
This may be useful if you need to do
additional computations later on that depend on these variables; e.g.,
bias adjustments for random slopes of variables not among the fixed predictors.</p></dd>


<dt id="arg-xlev">xlev<a class="anchor" aria-label="anchor" href="#arg-xlev"></a></dt>
<dd><p>Named list of factor levels (<em>excluding</em> ones coerced to
factors in the model formula)</p></dd>


<dt id="arg-grid">grid<a class="anchor" aria-label="anchor" href="#arg-grid"></a></dt>
<dd><p>A <code>data.frame</code> (provided by <code>ref_grid</code>) containing
the predictor settings needed in the reference grid</p></dd>


<dt id="arg-classes">classes<a class="anchor" aria-label="anchor" href="#arg-classes"></a></dt>
<dd><p>Character names of one or more classes to be registered.
The package must contain the functions <code>recover_data.foo</code> and
<code>emm_basis.foo</code> for each class <code>foo</code> listed in <code>classes</code>.</p></dd>


<dt id="arg-pkgname">pkgname<a class="anchor" aria-label="anchor" href="#arg-pkgname"></a></dt>
<dd><p>Character name of package providing the methods (usually
should be the second argument of <code>.onLoad</code>)</p></dd>


<dt id="arg-fam">fam<a class="anchor" aria-label="anchor" href="#arg-fam"></a></dt>
<dd><p>Result of call to <code>family(object)</code></p></dd>


<dt id="arg-misc">misc<a class="anchor" aria-label="anchor" href="#arg-misc"></a></dt>
<dd><p>A <code>list</code> intended for the <code>@misc</code> slot of an <code>emmGrid</code> object</p></dd>


<dt id="arg-k-dfargs">k, dfargs<a class="anchor" aria-label="anchor" href="#arg-k-dfargs"></a></dt>
<dd><p>Arguments to <code>.aovlist.dffun</code>, which is made available as a
convenience to developers providing support similar to that provided for
<code>aovlist</code> objects</p></dd>


<dt id="arg-x-weights-assign">X, weights, assign<a class="anchor" aria-label="anchor" href="#arg-x-weights-assign"></a></dt>
<dd><p>Arguments for <code>.cmpMM</code>, which compacts a model
matrix <code>X</code> into a much smaller matrix that has the same row space.
Specifically, it returns the R portion of its QR decomposition. If <code>X</code>
is already of class <code>qr</code>, it is used directly. <code>weights</code> should be
the weights used in the model fit, and <code>assign</code> is used for unravelling
any pivoting done by <code><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr</a></code>.</p></dd>


<dt id="arg-levs-key">levs, key<a class="anchor" aria-label="anchor" href="#arg-levs-key"></a></dt>
<dd><p>The <code>.num.key</code> function returns the numeric indices of
the levels in <code>levs</code> to the set of all levels in <code>key</code></p></dd>


<dt id="arg-exc-inc">exc, inc<a class="anchor" aria-label="anchor" href="#arg-exc-inc"></a></dt>
<dd><p>Arguments for <code>.get.excl</code> which is useful
in writing <code>.emmc</code> functions for generating contrast coefficients,
and supports arguments <code>exclude</code> or <code>include</code> for excluding
or specifying which levels to use.</p></dd>


<dt id="arg-terms">terms<a class="anchor" aria-label="anchor" href="#arg-terms"></a></dt>
<dd><p>A <code>terms</code> component</p></dd>


<dt id="arg-vcov-">vcov.<a class="anchor" aria-label="anchor" href="#arg-vcov-"></a></dt>
<dd><p>Function or matrix that returns a suitable covariance matrix.
The default is <code>.statsvcov</code> which is <code><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">stats::vcov</a></code>. The <code>.my.vcov</code>
function should be called in place of <code><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></code>, and it supports the user
being able to specify a different matrix or function via the
optional <code>vcov.</code> argument.</p></dd>


<dt id="arg-expr-retain">expr, retain<a class="anchor" aria-label="anchor" href="#arg-expr-retain"></a></dt>
<dd><p>Arguments for <code>.all.vars</code>, which is an alternative to <code><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars</a></code>
that has special provisions for retaining the special characters in <code>retain</code>,
thus allowing model specifications like <code>y ~ data$trt * df[["dose"]]</code></p></dd>


<dt id="arg-x-nrow-ncol">x, nrow, ncol<a class="anchor" aria-label="anchor" href="#arg-x-nrow-ncol"></a></dt>
<dd><p>Arguments for <code>.diag</code>, which is an alternative to
<code><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></code> that lacks its idiosyncrasy of returning an
identity matrix when <code>x</code> is of length 1.</p></dd>


<dt id="arg-css-package-highlight">css, package, highlight<a class="anchor" aria-label="anchor" href="#arg-css-package-highlight"></a></dt>
<dd><p>Arguments for <code>.emm_vignette</code>, which is
a clean and simple alternative to such as <code>html_document</code> for use
as the output style of a Markdown file. All the vignettes in the
<span class="pkg">emmeans</span> package use this output style.</p></dd>


<dt id="arg-cmu-zmu">cmu, zmu<a class="anchor" aria-label="anchor" href="#arg-cmu-zmu"></a></dt>
<dd><p>In <code>.hurdle.support</code> and <code>.zi.support</code>,
these specify a vector of back-transformed
estimates for the count and zero model, respectively</p></dd>


<dt id="arg-cshape-zshape">cshape, zshape<a class="anchor" aria-label="anchor" href="#arg-cshape-zshape"></a></dt>
<dd><p>Shape parameter for the count and zero model, respectively</p></dd>


<dt id="arg-cp-zp-">cp0, zp0<a class="anchor" aria-label="anchor" href="#arg-cp-zp-"></a></dt>
<dd><p>Function of <code>(mu, shape)</code> for computing Prob(Y = 0)
for the count and zero model, respectively</p></dd>


<dt id="arg-cmean">cmean<a class="anchor" aria-label="anchor" href="#arg-cmean"></a></dt>
<dd><p>Function of <code>(mu, shape)</code> for computing the mean of the
count model. Typically, this just returns <code>mu</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The <code>recover_data</code> method must return a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></code>
  containing all the variables that appear as predictors in the model,
  and attributes <code>"call"</code>, <code>"terms"</code>, <code>"predictors"</code>,
  and <code>"responses"</code>. (<code>recover_data.call</code> will
  provide these attributes.)</p>
<p>The <code>emm_basis</code> method should return a <code>list</code> with the
  following elements:</p><dl><dt>X</dt>
<dd><p>The matrix of linear functions over <code>grid</code>, having the same
  number of rows as <code>grid</code> and the number of columns equal to the length
  of <code>bhat</code>.</p></dd>

<dt>bhat</dt>
<dd><p>The vector of regression coefficients for fixed effects. This
  should <em>include</em> any <code>NA</code>s that result from rank deficiencies.</p></dd>

<dt>nbasis</dt>
<dd><p>A matrix whose columns form a basis for non-estimable functions
  of beta, or a 1x1 matrix of <code>NA</code> if there is no rank deficiency.</p></dd>

<dt>V</dt>
<dd><p>The estimated covariance matrix of <code>bhat</code>.</p></dd>

<dt>dffun</dt>
<dd><p>A function of <code>(k, dfargs)</code> that returns the degrees of
  freedom associated with <code>sum(k * bhat)</code>.</p></dd>

<dt>dfargs</dt>
<dd><p>A <code>list</code> containing additional arguments needed for
  <code>dffun</code></p></dd>
.

</dl><p><!-- %%% end of describe --></p>
<p><code>.recover_data</code> and <code>.emm_basis</code> are hidden exported versions of
  <code>recover_data</code> and <code>emm_basis</code>, respectively. They run in <span class="pkg">emmeans</span>'s
  namespace, thus providing access to all existing methods.</p>
<p><code>.std.link.llabels</code> returns a modified version of <code>misc</code>
  with the appropriate information included corresponding to the information in <code>fam</code></p>
<p><code>combine.terms</code> returns a <code>terms</code> object resulting
  from combining all the terms or formulas in <code>...</code>.</p>
<p><code>.get.offset</code> returns the values, based on <code>grid</code>, of
any <code>offset</code> component in <code>terms</code></p>
<p><code>.hurdle.support</code> returns a matrix with 3 rows containing the
      estimated mean responses and the differentials wrt <code>cmu</code> and <code>zmu</code>,
      resp.</p>
<p><code>.zi.support</code> returns a matrix with 2 rows containing the
      estimated probabilities of 0 and the differentials wrt <code>mu</code>.
      See the section on hurdle and zero-inflated models.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>Without an explicit <code>data</code> argument, <code>recover_data</code> returns
   the <em>current version</em> of the dataset. If the dataset has changed
   since the model was fitted, then this will not be the data used to fit
   the model. It is especially important to know this in simulation studies
   where the data are randomly generated or permuted, and in cases where
   several datasets are processed in one step (e.g., using <code>dplyr</code>).
   In those cases, users should be careful to provide the actual data
   used to fit the model in the <code>data</code> argument.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>


<p>To create a reference grid, the <code>ref_grid</code> function needs to reconstruct
the data used in fitting the model, and then obtain a matrix of linear
functions of the regression coefficients for a given grid of predictor
values. These tasks are performed by calls to <code>recover_data</code> and
<code>emm_basis</code> respectively. A vignette giving details and examples
is available via <a href="../doc/xtending.html">vignette("xtending", "emmeans")</a></p>
<p>To extend <span class="pkg">emmeans</span>'s support to additional model types, one need only
write S3 methods for these two functions. The existing methods serve as
helpful guidance for writing new ones.  Most of the work for
<code>recover_data</code> can be done by its method for class <code>"call"</code>,
providing the <code>terms</code> component and <code>na.action</code> data as additional
arguments. Writing an <code>emm_basis</code> method is more involved, but the
existing methods (e.g., <code>emmeans:::emm_basis.lm</code>) can serve as models.
Certain <code>recover_data</code> and <code>emm_basis</code> methods are exported from
<span class="pkg">emmeans</span>. (To find out, do <code>methods("recover_data")</code>.) If your
object is based on another model-fitting object, it
may be that all that is needed is to call one of these exported methods and
perhaps make modifications to the results. Contact the developer if you need
others of these exported.</p>
<p>If the model has a multivariate response, <code>bhat</code> needs to be
“flattened” into a single vector, and <code>X</code> and <code>V</code> must be
constructed consistently.</p>
<p>In models where a non-full-rank result is possible (often, you can tell by
seeing if there is a <code>singular.ok</code> argument in the model-fitting
function), <code><a href="summary.emmGrid.html">summary.emmGrid</a></code> and its relatives check the
estimability of each
prediction, using the <code><a href="https://rvlenth.github.io/estimability/reference/nonest.basis.html" class="external-link">nonest.basis</a></code> function in
the <span class="pkg">estimability</span> package.</p>
<p>The models already supported are detailed in <a href="../doc/models.html">the
"models" vignette</a>. Some packages may provide additional <span class="pkg">emmeans</span>
support for its object classes.</p>
    </div>
    <div class="section level2">
    <h2 id="communication-between-methods">Communication between methods<a class="anchor" aria-label="anchor" href="#communication-between-methods"></a></h2>


<p>If the <code>recover_data</code> method generates information needed by <code>emm_basis</code>,
that information may be incorporated by creating a <code>"misc"</code> attribute in the
returned recovered data. That information is then passed as the <code>misc</code>
argument when <code>ref_grid</code> calls <code>emm_basis</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="optional-hooks">Optional hooks<a class="anchor" aria-label="anchor" href="#optional-hooks"></a></h2>


<p>Some models may need something other than standard linear estimates and
standard errors. If so, custom functions may be pointed to via the items
<code>misc$estHook</code>, <code>misc$vcovHook</code> and <code>misc$postGridHook</code>. If
just the name of the hook function is provided as a character string, then it
is retrieved using <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></code>.</p>
<p>The <code>estHook</code> function should have arguments <samp>(object, do.se, tol,
...)</samp> where <code>object</code> is the <code>emmGrid</code> object,
<code>do.se</code> is a logical flag for whether to return the standard error, and
<code>tol</code> is the tolerance for assessing estimability. It should return a
matrix with 3 columns: the estimates, standard errors (<code>NA</code> when
<code>do.se==FALSE</code>), and degrees of freedom (<code>NA</code> for asymptotic). The
number of rows should equal <samp>nrow(linfct(object)</samp>. The
<code>vcovHook</code> function should have arguments <samp>(object, tol, ...)</samp> as
described. It should return the covariance matrix for the estimates. Finally,
<code>postGridHook</code>, if present, is called at the very end of
<code>ref_grid</code>; it takes one argument, the constructed <code>object</code>, and
should return a suitably modified <code>emmGrid</code> object.</p>
    </div>
    <div class="section level2">
    <h2 id="registering-s-methods-for-a-model-class">Registering S3 methods for a model class<a class="anchor" aria-label="anchor" href="#registering-s-methods-for-a-model-class"></a></h2>


<p>The <code>.emm_register</code> function is provided as a convenience to conditionally
register your
S3 methods for a model class, <code>recover_data.foo</code> and <code>emm_basis.foo</code>,
where <code>foo</code> is the class name. Your package should implement an
<code>.onLoad</code> function and call <code>.emm_register</code> if <span class="pkg">emmeans</span> is
installed. See the example.</p>
    </div>
    <div class="section level2">
    <h2 id="support-for-hurdle-and-zero-inflated-models">Support for Hurdle and Zero-inflated models<a class="anchor" aria-label="anchor" href="#support-for-hurdle-and-zero-inflated-models"></a></h2>


<p>The functions <code>.hurdle.support</code> and <code>.zi.support</code> help facilitate
  calculations needed to estimate the mean response (count model and zero model
  combined) of these models. <code>.hurdle.support</code> returns a matrix of three rows.
  The first is the estimated mean for a hurdle model, and the 2nd and 3rd rows are
  differentials for the count and zero models, which needed for delta-method
  calculations. To use these, regard the <code>@linfct</code> slot as comprising
  two sets of columns, for the count and zero models respectively. To do
  the delta method calculations, multiply the rows of the count part by its
  differentials times <code>link$mu.eta</code> evcaluated at that part of the linear predictor.
  Do the same for the zero part, using its differentials and <code>mu.eta</code>.
  If the resulting matrix is <b>A</b>, then the covariance of the mean response
  is <b>AVA'</b> where <b>V</b>is the <code>@V</code> slot of the object.</p>
<p>The function <code>zi.support</code> works the same way, only it is much simpler,
  and is used to estimate the probability of 0 and its differential for either
  part of a zero-inflated model or hurdle model.</p>
<p>See the code for <code>emm_basis.zeroinfl</code> and <code>emm_basis.hurdle</code>
  for how these are used with models fitted by the <span class="pkg">pscl</span> package.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="../doc/xtending.html">Vignette on extending emmeans</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co">#--- If your package provides recover_data and emm_grid methods for class 'mymod',</span></span></span>
<span class="r-in"><span><span class="co">#--- put something like this in your package code -- say in zzz.R:</span></span></span>
<span class="r-in"><span>  <span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"emmeans"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="fu">emmeans</span><span class="fu">::</span><span class="fu">.emm_register</span><span class="op">(</span><span class="st">"mymod"</span>, <span class="va">pkgname</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell V. Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

